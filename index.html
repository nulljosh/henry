<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Spreadsheet</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f9fafb; }
        .header { background: white; border-bottom: 1px solid #e5e7eb; padding: 12px 24px; }
        .header h1 { font-size: 20px; font-weight: 600; color: #111827; }
        .container { max-width: 1280px; margin: 0 auto; padding: 24px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; overflow: hidden; }
        
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f9fafb; border-bottom: 1px solid #e5e7eb; }
        th { padding: 12px 24px; text-align: left; font-size: 12px; font-weight: 500; color: #6b7280; text-transform: uppercase; }
        th:last-child { text-align: right; }
        tbody tr { border-bottom: 1px solid #f3f4f6; }
        tbody tr:hover { background: #f9fafb; }
        td { padding: 16px 24px; }
        td:last-child { text-align: right; }
        
        input { width: 96px; text-align: right; background: transparent; border: none; outline: none; padding: 4px 8px; border-radius: 4px; }
        input:focus { background: #dbeafe; box-shadow: 0 0 0 2px #3b82f6; }
        
        .goal { color: #059669; font-weight: 600; }
        .asset { color: #2563eb; font-weight: 600; }
        .income { color: #059669; font-weight: 600; }
        .expense { color: #dc2626; }
        .calculated { color: #7c3aed; font-weight: 600; }
        
        .chart-section { border-top: 1px solid #e5e7eb; background: #f9fafb; padding: 24px; }
        .chart-container { background: white; border-radius: 8px; border: 1px solid #e5e7eb; padding: 24px; margin-bottom: 16px; position: relative; overflow: hidden; overflow-x: auto; }
        .chart { width: 100%; height: 320px; min-width: 100%; }
        .tooltip { position: absolute; top: 8px; left: 8px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); z-index: 20; display: none; font-size: 14px; }
        
        .stocks-section { border-top: 1px solid #e5e7eb; background: #f9fafb; padding: 24px; }
        .stock-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .index-list { display: flex; flex-direction: column; gap: 8px; }
        .stock-row { background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; }
        .stock-row:hover { border-color: #10b981; box-shadow: 0 1px 3px rgba(16, 185, 129, 0.1); }
        .stock-row a { text-decoration: none; color: inherit; display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .stock-left { display: flex; align-items: center; gap: 12px; }
        .stock-symbol { font-weight: 600; color: #374151; font-size: 14px; min-width: 60px; }
        .stock-prices { font-size: 13px; color: #6b7280; }
        .stock-gain { font-size: 14px; font-weight: 600; color: #059669; min-width: 80px; text-align: right; }

        /* Mobile responsive breakpoints */
        @media (max-width: 768px) {
            .container { padding: 16px; }
            .header { padding: 12px 16px; }
            .chart-section { padding: 16px; }
            .chart-container { padding: 16px 8px; overflow-x: auto; }
            .chart { min-width: 700px; height: 280px; }
            .stocks-section { padding: 16px; }
            .stock-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .summary-grid { grid-template-columns: 1fr; gap: 12px; }
            .stock-card { padding: 16px; }
            .stock-symbol { font-size: 16px; font-weight: 600; }
            .stock-subtitle { font-size: 13px; margin-bottom: 6px; }
            .stock-price { font-size: 20px; line-height: 1.2; }
            .stock-gain { font-size: 13px; margin-top: 4px; }
            th, td { padding: 8px 12px; }
            .header h1 { font-size: 18px; }
        }

        @media (max-width: 480px) {
            .container { padding: 12px; }
            .header { padding: 8px 12px; }
            .chart-section { padding: 12px; }
            .chart-container {
                padding: 12px 4px;
                margin-left: -4px;
                margin-right: -4px;
            }
            .chart {
                min-width: 100%;
                width: 100%;
                height: 400px;
            }
            .stocks-section { padding: 12px; }
            .stock-grid { grid-template-columns: 1fr; gap: 12px; }
            .stock-card {
                padding: 20px 16px;
                text-align: center;
                min-height: 140px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            .stock-symbol {
                font-size: 18px;
                font-weight: 700;
                margin-bottom: 4px;
                color: #374151;
            }
            .stock-subtitle {
                font-size: 14px;
                margin-bottom: 8px;
                color: #6b7280;
                line-height: 1.3;
            }
            .stock-price {
                font-size: 24px;
                font-weight: 700;
                line-height: 1.1;
                margin: 8px 0;
            }
            .stock-gain {
                font-size: 14px;
                font-weight: 600;
                margin-top: 6px;
            }
            th, td { padding: 8px 6px; font-size: 14px; }
            .header h1 { font-size: 16px; }

            /* Make table more readable on mobile */
            table { font-size: 14px; }
            .summary-section { padding: 16px 12px; }
        }
        
        .summary-section { border-top: 1px solid #e5e7eb; padding: 24px; }
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .summary-card { text-align: center; padding: 12px; border-radius: 8px; }
        .green-bg { background: #ecfdf5; }
        .blue-bg { background: #eff6ff; }
        .purple-bg { background: #faf5ff; }
        .summary-value { font-size: 18px; font-weight: 600; }
        .green-text { color: #059669; }
        .blue-text { color: #2563eb; }
        .purple-text { color: #7c3aed; }
        .summary-label { font-size: 12px; margin-top: 4px; }
        
        .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #666; }
        .footer .heart { animation: heartbeat 2s ease-in-out infinite; display: inline-block; vertical-align: middle; }
        @keyframes heartbeat { 0% { transform: scale(1); } 10% { transform: scale(1.2); } 20% { transform: scale(1); } 30% { transform: scale(1.15); } 40% { transform: scale(1); } 100% { transform: scale(1); } }

        .collapse-header { cursor: pointer; padding: 16px 24px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; user-select: none; }
        .collapse-header:hover { background: #f3f4f6; }
        .collapse-arrow { transition: transform 0.2s; font-size: 12px; color: #6b7280; }
        .collapse-arrow.open { transform: rotate(180deg); }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .collapsible-content.open { max-height: 2000px; }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>Marlin</h1>
            <div id="lastUpdated" style="font-size: 11px; color: #9ca3af; margin-top: 2px;">Loading...</div>
        </div>
    </div>

    <div class="container">
        <div class="card" style="margin-bottom: 24px;">
            <div class="chart-section" style="border-top: none; padding-top: 24px;">
                <h3 style="font-weight: 600; margin-bottom: 16px; color: #111827;">Portfolio Growth</h3>
                <div class="chart-container">
                    <svg id="chart" viewBox="0 0 1000 300" class="chart" preserveAspectRatio="xMidYMid meet">
                        <!-- Dynamic chart content -->
                    </svg>
                    <div id="tooltip" class="tooltip"></div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 20px;">
                    <div style="text-align: center; padding: 12px; border-radius: 6px; background: #ecfdf5;">
                        <div id="progressValue" style="font-size: 18px; font-weight: 600; color: #059669;">12.7%</div>
                        <div style="font-size: 12px; margin-top: 4px; color: #166534;">Progress</div>
                    </div>
                    <div style="text-align: center; padding: 12px; border-radius: 6px; background: #eff6ff;">
                        <div id="monthlyTarget" style="font-size: 18px; font-weight: 600; color: #2563eb;">$417</div>
                        <div style="font-size: 12px; margin-top: 4px; color: #1e40af;">Monthly Target</div>
                    </div>
                    <div style="text-align: center; padding: 12px; border-radius: 6px; background: #faf5ff;">
                        <div id="monthlySurplus" style="font-size: 18px; font-weight: 600; color: #7c3aed;">-$69</div>
                        <div style="font-size: 12px; margin-top: 4px; color: #6b21a8;">Monthly Surplus</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="collapse-header" onclick="toggleBudget()">
                <h3 style="font-weight: 600; margin: 0; color: #111827; font-size: 16px;">Budget Details</h3>
                <span class="collapse-arrow" id="budgetArrow">▼</span>
            </div>
            <div class="collapsible-content" id="budgetContent">
                <table>
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>

            <div class="collapse-header" onclick="togglePortfolio()">
                <h3 style="font-weight: 600; margin: 0; color: #111827; font-size: 16px;">Portfolio Targets</h3>
                <span class="collapse-arrow" id="portfolioArrow">▼</span>
            </div>
            <div class="collapsible-content" id="portfolioContent">
                <div class="stocks-section" style="border-top: none; padding-top: 0;">
                    <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dbeafe 100%); border: 1px solid #10b981; border-radius: 8px; padding: 16px; margin-bottom: 20px; margin-top: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-weight: 600; color: #059669; font-size: 14px;">🚀 Avg +78% upside by 2027-2028</div>
                            <select id="sortBy" style="padding: 6px 10px; border-radius: 4px; border: 1px solid #10b981; font-size: 12px; color: #059669; background: white; font-weight: 500;">
                                <option value="gain">By Potential %</option>
                                <option value="price">By Price</option>
                                <option value="alpha">By Ticker</option>
                            </select>
                        </div>
                    </div>

                    <div class="stock-list">
                        <!-- Stock rows will be dynamically rendered here -->
                    </div>

                    <h3 style="font-weight: 600; margin: 32px 0 16px 0; color: #111827;">Market Indices</h3>
                    <div class="index-list">
                        <!-- Index rows will be dynamically rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer" style="padding-bottom: 40px;">Made with <svg class="heart" width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" fill="#FF4136"/></svg> in Vancouver, BC</div>

    <script>
        let data = [
            { category: 'Goal', amount: 5000, type: 'goal' },
            { category: 'Wallet / Savings', amount: 1480, type: 'asset' },
            { category: 'Income', amount: 1060, type: 'income' },
            { category: 'Food', amount: 335, type: 'expense' },
            { category: 'iPhone (Back Pay)', amount: 300, type: 'expense' },
            { category: 'iPhone (Monthly)', amount: 105, type: 'expense' },
            { category: 'Vape', amount: 144, type: 'expense' },
            { category: 'Weed', amount: 100, type: 'expense' }
        ];

        function get(category) {
            const item = data.find(item => item.category === category);
            return item ? item.amount : 0;
        }

        function calculateSurplus() {
            const income = get('Income');
            const totalExpenses = get('Food') + get('iPhone (Monthly)') + get('iPhone (Back Pay)') + get('Vape') + get('Weed');
            return income - totalExpenses;
        }

        function calculateNeeded() {
            return get('Goal') - get('Wallet / Savings');
        }

        function projectValue(months) {
            const r = 0.015; // Individual stocks: 1.5% monthly
            const surplus = calculateSurplus();
            
            const fv = get('Wallet / Savings') * Math.pow(1 + r, months);
            const annuity = surplus * ((Math.pow(1 + r, months) - 1) / r);
            
            return fv + annuity;
        }

        function generateChartData() {
            const chartData = [];
            const r = 0.015; // 1.5% monthly growth rate
            const currentValue = get('Wallet / Savings');
            const surplus = calculateSurplus();
            const monthsAgo = 12; // Start from 12 months ago (Oct/Nov 2024)

            // Calculate starting value that would grow to currentValue
            // Working backwards with same growth rate to reach $0 at monthsAgo
            // We want: startValue * (1+r)^24 + surplus * annuity = currentValue
            // Solving for a path that starts near 0

            const totalMonthsFromStart = monthsAgo;
            // This is the theoretical starting value
            const backProjectedStart = (currentValue - (surplus * ((Math.pow(1 + r, totalMonthsFromStart) - 1) / r))) / Math.pow(1 + r, totalMonthsFromStart);

            // Generate past data (from -24 to 0) using forward projection from theoretical start
            for (let i = -monthsAgo; i <= 0; i++) {
                const date = new Date(Date.now() + i * 30 * 24 * 60 * 60 * 1000);
                const monthYear = date.toLocaleDateString('en', { month: 'short', year: '2-digit' });

                // Months elapsed since the start (at -24)
                const monthsElapsed = monthsAgo + i;

                // Project forward from the theoretical start
                const fv = Math.max(0, backProjectedStart) * Math.pow(1 + r, monthsElapsed);
                const annuity = monthsElapsed > 0 ? surplus * ((Math.pow(1 + r, monthsElapsed) - 1) / r) : 0;
                const val = Math.max(0, fv + annuity);

                chartData.push({
                    month: monthYear.replace(/(\d{2})$/, "'$1"),
                    val: val,
                    monthIndex: i
                });
            }

            // Generate future data (from 1 to 24)
            for (let i = 1; i <= 24; i++) {
                const date = new Date(Date.now() + i * 30 * 24 * 60 * 60 * 1000);
                const monthYear = date.toLocaleDateString('en', { month: 'short', year: '2-digit' });
                chartData.push({
                    month: monthYear.replace(/(\d{2})$/, "'$1"),
                    val: projectValue(i),
                    monthIndex: i
                });
            }

            return chartData;
        }

        function updateTable() {
            const tbody = document.getElementById('dataTable');
            const surplus = calculateSurplus();
            const needed = calculateNeeded();
            
            tbody.innerHTML = '';
            
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 500;">${item.category}</td>
                    <td>
                        <input type="text" value="${item.amount.toLocaleString()}" 
                               class="${item.type}" data-index="${index}"
                               onchange="updateValue(${index}, this.value)">
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Add calculated rows
            const surplusRow = document.createElement('tr');
            surplusRow.innerHTML = `
                <td style="font-weight: 500;">Monthly Surplus</td>
                <td class="calculated">$${surplus.toLocaleString()}</td>
            `;
            tbody.appendChild(surplusRow);

            const neededRow = document.createElement('tr');
            neededRow.innerHTML = `
                <td style="font-weight: 500;">Amount Needed</td>
                <td class="calculated">$${needed.toLocaleString()}</td>
            `;
            tbody.appendChild(neededRow);
        }

        function updateChart() {
            const chartData = generateChartData();
            const maxVal = Math.max(...chartData.map(d => d.val));
            const minVal = Math.min(...chartData.map(d => d.val));
            const svg = document.getElementById('chart');

            // Get current viewBox height
            const viewBox = svg.getAttribute('viewBox').split(' ');
            const viewBoxHeight = parseFloat(viewBox[3]);

            // Calculate responsive dimensions based on viewBox
            const marginTop = viewBoxHeight * 0.133; // 40 for 300, scales proportionally
            const marginBottom = viewBoxHeight * 0.1; // 30 for 300
            const chartHeight = viewBoxHeight - marginTop - marginBottom;
            const labelY = viewBoxHeight - 20;
            const hoverHeight = chartHeight;

            svg.innerHTML = '';

            // Add grid lines
            for (let i = 0; i <= 4; i++) {
                const y = marginTop + (i * chartHeight / 4);
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', '60');
                line.setAttribute('y1', y);
                line.setAttribute('x2', '960');
                line.setAttribute('y2', y);
                line.setAttribute('stroke', '#e5e7eb');
                line.setAttribute('stroke-width', '1');
                svg.appendChild(line);

                // Add Y-axis labels
                const val = maxVal - (i * (maxVal - minVal) / 4);
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', '50');
                label.setAttribute('y', y + 4);
                label.setAttribute('text-anchor', 'end');
                label.setAttribute('font-size', '11');
                label.setAttribute('fill', '#6b7280');
                label.textContent = '$' + Math.round(val).toLocaleString();
                svg.appendChild(label);
            }

            const bottomY = marginTop + chartHeight;

            // Create polyline
            const points = chartData.map((d, i) => `${80 + (i * 860/(chartData.length-1))},${bottomY - ((d.val-minVal)/(maxVal-minVal)) * chartHeight}`).join(' ');
            const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
            polyline.setAttribute('points', points);
            polyline.setAttribute('fill', 'none');
            polyline.setAttribute('stroke', '#4ade80');
            polyline.setAttribute('stroke-width', '3');
            svg.appendChild(polyline);

            // Add circles and hover areas (only every 3rd point for cleaner look)
            chartData.forEach((d, i) => {
                const x = 80 + (i * 860/(chartData.length-1));
                const y = bottomY - ((d.val-minVal)/(maxVal-minVal)) * chartHeight;

                // Only show circles every 6 months
                if (i % 6 === 0 || d.monthIndex === 0) {
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', x);
                    circle.setAttribute('cy', y);
                    circle.setAttribute('r', '5');
                    circle.setAttribute('fill', '#4ade80');
                    svg.appendChild(circle);
                }

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', x - 20);
                rect.setAttribute('y', marginTop);
                rect.setAttribute('width', '40');
                rect.setAttribute('height', hoverHeight);
                rect.setAttribute('fill', 'transparent');
                rect.style.cursor = 'pointer';
                rect.addEventListener('mouseenter', () => showTooltip(i, d));
                rect.addEventListener('mouseleave', hideTooltip);
                svg.appendChild(rect);
            });

            // Add "NOW" marker at month 0 (which is at index 24 in the array)
            const nowIndex = chartData.findIndex(d => d.monthIndex === 0);
            if (nowIndex >= 0) {
                const currentX = 80 + (nowIndex * 860/(chartData.length-1));
                const currentY = bottomY - ((chartData[nowIndex].val-minVal)/(maxVal-minVal)) * chartHeight;
                const marker = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                marker.setAttribute('cx', currentX);
                marker.setAttribute('cy', currentY);
                marker.setAttribute('r', '7');
                marker.setAttribute('fill', '#2563eb');
                marker.setAttribute('stroke', 'white');
                marker.setAttribute('stroke-width', '2');
                svg.appendChild(marker);

                const currentLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                currentLabel.setAttribute('x', currentX);
                currentLabel.setAttribute('y', currentY - 14);
                currentLabel.setAttribute('text-anchor', 'middle');
                currentLabel.setAttribute('font-size', '12');
                currentLabel.setAttribute('font-weight', '600');
                currentLabel.setAttribute('fill', '#2563eb');
                currentLabel.textContent = 'NOW';
                svg.appendChild(currentLabel);
            }

            // Add month labels (every 6 months for better spacing)
            chartData.forEach((d, i) => {
                if (i % 6 === 0 || d.monthIndex === 0) {
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', 80 + (i * 860/(chartData.length-1)));
                    text.setAttribute('y', labelY);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('font-size', '12');
                    text.setAttribute('fill', '#6b7280');
                    text.textContent = d.month;
                    svg.appendChild(text);
                }
            });
        }

        function showTooltip(index, data) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <div style="font-weight: 500;">${data.month}</div>
                <div style="color: #059669;">$${Math.round(data.val).toLocaleString()}</div>
                <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">Mixed portfolio projection</div>
            `;
            tooltip.style.display = 'block';
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        function updateValue(index, value) {
            const cleanValue = parseFloat(value.replace(/,/g, '')) || 0;
            data[index].amount = cleanValue;
            updateAll();
        }

        function updateSummary() {
            const progress = (get('Wallet / Savings') / get('Goal') * 100).toFixed(1);
            const surplus = calculateSurplus();
            const needed = calculateNeeded();
            const monthlyTarget = Math.round(needed / 21);
            
            document.getElementById('progressValue').textContent = `${progress}%`;
            document.getElementById('monthlyTarget').textContent = `$${monthlyTarget.toLocaleString()}`;
            document.getElementById('monthlySurplus').textContent = `$${surplus.toLocaleString()}`;
        }

        function updateAll() {
            updateTable();
            updateChart();
            updateSummary();
        }

        // Stock data (ordered by growth potential)
        const stocks = {
            'PLTR': { current: 184, target: 450, year: 2028 },  // +145%
            'HOOD': { current: 139, target: 300, year: 2027 },  // +116%
            'GOOGL': { current: 243, target: 500, year: 2028 }, // +106%
            'COIN': { current: 308, target: 600, year: 2027 },  // +95%
            'NVDA': { current: 186, target: 300, year: 2027 },  // +61%
            'APP': { current: 702, target: 1000, year: 2027 },  // +42%
            'META': { current: 734, target: 1000, year: 2028 }, // +36%
            'TSLA': { current: 460, target: 550, year: 2028 }   // +20%
        };

        // Index data (ordered by growth potential)
        const indices = {
            'QQQ': { current: 603.59, target: 670, year: 2025, name: 'Nasdaq 100 (QQQ)' },      // +11%
            '^GSPC': { current: 6715, target: 7000, year: 2025, name: 'S&P 500' },              // +4%
            '^GSPTSE': { current: 30128.61, target: 31359, year: 2025, name: 'TSX Composite' }  // +4%
        };

        // Fetch live price from Yahoo Finance
        async function fetchPrice(symbol) {
            try {
                const res = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`);
                const data = await res.json();
                return Math.round(data.chart.result[0].meta.regularMarketPrice);
            } catch (e) {
                console.error(`Error fetching ${symbol}:`, e);
                return null;
            }
        }

        // Update all stock prices
        async function updatePrices() {
            for (const sym in stocks) {
                const price = await fetchPrice(sym);
                if (price) stocks[sym].current = price;
                await new Promise(r => setTimeout(r, 200));
            }
            for (const sym in indices) {
                const price = await fetchPrice(sym);
                if (price) indices[sym].current = price;
                await new Promise(r => setTimeout(r, 200));
            }
            const time = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', second: '2-digit' });
            document.getElementById('lastUpdated').textContent = `Updated: ${time}`;
            renderCards();
            renderIndices();
        }

        // Sort and render stock rows
        function renderCards() {
            const sortBy = document.getElementById('sortBy').value;
            const sorted = Object.entries(stocks).sort((a, b) => {
                if (sortBy === 'gain') {
                    const gA = ((a[1].target - a[1].current) / a[1].current) * 100;
                    const gB = ((b[1].target - b[1].current) / b[1].current) * 100;
                    return gB - gA;
                }
                if (sortBy === 'price') return b[1].current - a[1].current;
                if (sortBy === 'alpha') return a[0].localeCompare(b[0]);
            });

            const list = document.querySelector('.stock-list');
            list.innerHTML = sorted.map(([sym, s]) => {
                const gain = Math.round(((s.target - s.current) / s.current) * 100);
                return `<div class="stock-row">
                    <a href="https://finance.yahoo.com/quote/${sym}" target="_blank">
                        <div class="stock-left">
                            <div class="stock-symbol">${sym}</div>
                            <div class="stock-prices">$${s.current.toLocaleString()} → $${s.target.toLocaleString()}</div>
                        </div>
                        <div class="stock-gain">+${gain}%</div>
                    </a>
                </div>`;
            }).join('');
        }

        // Render index rows
        function renderIndices() {
            const list = document.querySelector('.index-list');
            list.innerHTML = Object.entries(indices).map(([sym, idx]) => {
                const gain = Math.round(((idx.target - idx.current) / idx.current) * 100);
                return `<div class="stock-row">
                    <a href="https://finance.yahoo.com/quote/${sym}" target="_blank">
                        <div class="stock-left">
                            <div class="stock-symbol">${idx.name}</div>
                            <div class="stock-prices">$${idx.current.toLocaleString()} → $${idx.target.toLocaleString()}</div>
                        </div>
                        <div class="stock-gain">+${gain}%</div>
                    </a>
                </div>`;
            }).join('');
        }

        // Toggle sections
        function toggleBudget() {
            const content = document.getElementById('budgetContent');
            const arrow = document.getElementById('budgetArrow');
            content.classList.toggle('open');
            arrow.classList.toggle('open');
        }

        function togglePortfolio() {
            const content = document.getElementById('portfolioContent');
            const arrow = document.getElementById('portfolioArrow');
            content.classList.toggle('open');
            arrow.classList.toggle('open');
        }

        // Adjust SVG viewBox for mobile
        function adjustChartViewBox() {
            const svg = document.getElementById('chart');
            if (window.innerWidth <= 480) {
                svg.setAttribute('viewBox', '0 0 1000 450');
            } else {
                svg.setAttribute('viewBox', '0 0 1000 300');
            }
            updateChart(); // Redraw chart with new viewBox
        }

        // Initialize
        adjustChartViewBox();
        window.addEventListener('resize', adjustChartViewBox);
        updateAll();
        renderCards();
        renderIndices();
        updatePrices();
        setInterval(updatePrices, 60000); // Update every 1 minute
        document.getElementById('sortBy').addEventListener('change', renderCards);
    </script>
</body>
</html>