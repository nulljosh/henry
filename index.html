<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="version" content="2.1.0">
    <title>Finn - Portfolio Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            height: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
            padding: 0;
            color: #1d1d1f;
            display: flex;
            flex-direction: column;
        }

        :root {
            --accent: #0074D9;
            --success: #34c759;
            --text-secondary: #86868b;
        }
        :root {
            --logo-ring: rgba(255, 255, 255, 0.7);
        }

        .back-button, .theme-toggle {
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1d1d1f;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .back-button {
            text-decoration: none;
            font-size: 20px;
        }

        .theme-toggle {
            font-size: 18px;
            cursor: pointer;
            border: none;
        }

        .back-button:hover, .theme-toggle:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .back-button:active, .theme-toggle:active {
            transform: scale(0.98);
        }

        body.dark .back-button,
        body.dark .theme-toggle {
            background: rgba(28, 28, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }

        body.dark .back-button:hover,
        body.dark .theme-toggle:hover {
            background: rgba(44, 44, 46, 1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        body.dark {
            background: #1d1d1f;
            color: #f5f5f7;
            --text-secondary: #98989d;
            --logo-ring: rgba(0, 0, 0, 0.6);
        }

        body.dark .glass-card {
            background: #1c1c1e;
            border-color: rgba(255, 255, 255, 0.1);
        }

        body.dark h1, body.dark h2 {
            color: #f5f5f7;
        }

        body.dark p {
            color: #98989d;
        }

        body.dark table {
            background: #2c2c2e;
        }

        body.dark thead {
            background: #1d1d1f;
        }

        body.dark th {
            color: #98989d;
        }

        body.dark td {
            color: #f5f5f7;
            border-top-color: rgba(255, 255, 255, 0.1);
        }

        body.dark tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 80px 20px 0;
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .glass-card {
            background: white;
            border-radius: 24px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
        }

        /* Remove card styling from tab pages */
        .tab-content.glass-card {
            background: transparent !important;
            border: none !important;
            border-radius: 0;
            box-shadow: none !important;
            padding: 24px 20px;
            margin-bottom: 0;
        }
        .tab-content.glass-card:hover {
            transform: none;
            box-shadow: none;
        }

        .site-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            gap: 12px;
            z-index: 1000;
        }

        .brand-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 0 14px;
            height: 44px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform-origin: left center;
        }

        body.dark .brand-badge {
            background: rgba(28, 28, 30, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .brand-name {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.3px;
            line-height: 1;
        }

        .brand-tagline {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
            line-height: 1;
            margin-top: 3px;
        }

        .portfolio-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 12px;
            margin-top: 0;
        }


        .view-toggle {
            display: inline-flex;
            padding: 4px;
            border-radius: 999px;
            background: rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .view-toggle button {
            font-size: 13px;
            font-weight: 600;
            padding: 6px 14px;
            border: none;
            border-radius: 999px;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #1d1d1f;
        }

        .view-toggle button.active {
            background: #0074D9;
            color: #f5f5f7;
            box-shadow: 0 4px 10px rgba(0, 122, 255, 0.25);
        }

        body.dark .view-toggle {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        body.dark .view-toggle button {
            color: #f5f5f7;
        }

        body.dark .view-toggle button.active {
            background: rgba(10, 132, 255, 0.85);
            box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3);
        }

        .portfolio-views {
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .portfolio-pie-view {
            display: flex;
            gap: 48px;
            align-items: center;
            flex-wrap: nowrap;
            flex: 1;
            padding: 20px 0;
        }

        .pie-chart-wrapper {
            position: relative;
            width: 360px;
            height: 360px;
            display: grid;
            place-items: center;
        }

        .pie-chart {
            width: 360px;
            height: 360px;
            border-radius: 50%;
            position: relative;
            overflow: visible;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.08);
            transition: transform 0.25s ease, box-shadow 0.25s ease;
            background: transparent;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }

        .pie-chart canvas {
            width: 360px;
            height: 360px;
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 50%;
            pointer-events: none;
        }

        .pie-chart.slice-active {
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.18), 0 0 0 8px rgba(0, 0, 0, 0.04);
            transform: translate(var(--slice-shift-x), var(--slice-shift-y)) scale(1.015);
        }

        .pie-center-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-weight: 700;
            font-size: 26px;
            color: #1d1d1f;
            padding: 18px 24px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            min-width: 160px;
            line-height: 1.3;
        }

        body.dark .pie-center-label {
            background: rgba(28, 28, 30, 0.92);
            color: #f5f5f7;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .pie-center-label span {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #6e6e73;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        body.dark .pie-center-label span {
            color: #d1d1d6;
        }

        .chart-legend {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            flex: 1;
            max-width: none;
            min-width: 500px;
        }

        @media (max-width: 768px) {
            .chart-legend {
                grid-template-columns: repeat(2, 1fr);
                min-width: unset;
            }
        }

        .chart-legend li {
            display: flex;
            align-items: center;
            gap: 14px;
            background: transparent;
            border-radius: 16px;
            padding: 20px 24px;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        body.dark .chart-legend li {
            border-color: rgba(255, 255, 255, 0.12);
        }

        .legend-swatch {
            width: 18px;
            height: 18px;
            border-radius: 50%;
        }

        .legend-label {
            font-weight: 600;
            color: #1d1d1f;
            font-size: 16px;
        }

        body.dark .legend-label {
            color: #f5f5f7;
        }

        .legend-value {
            margin-left: auto;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 16px;
        }

        body.dark .legend-value {
            color: #d1d1d6;
        }

        .chart-legend li.active {
            background: transparent;
            border-color: rgba(0, 122, 255, 0.5);
            color: #0074D9;
        }

        body.dark .chart-legend li.active {
            background: transparent;
            border-color: rgba(10, 132, 255, 0.7);
            color: #0a84ff;
        }

        .pie-logo-ring {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            transition: transform 0.25s ease;
        }

        .pie-logo {
            position: absolute;
            transform: translate(-50%, -50%);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            font-size: 15px;
            font-weight: 700;
            color: #1d1d1f;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.18), 0 0 0 3px var(--logo-ring);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }

        .pie-logo span {
            pointer-events: none;
        }

        .pie-logo svg {
            width: 22px;
            height: 22px;
            display: block;
            pointer-events: none;
        }

        body.dark .pie-logo {
            color: #f5f5f7;
        }

        .pie-logo:hover,
        .pie-logo:focus-visible {
            transform: translate(-50%, -50%) scale(1.12);
            box-shadow: 0 10px 22px rgba(0, 0, 0, 0.25), 0 0 0 3px var(--logo-ring);
        }

        body.dark .pie-logo:hover,
        body.dark .pie-logo:focus-visible {
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.5), 0 0 0 3px var(--logo-ring);
        }

        .pie-logo.active {
            transform: translate(-50%, -50%) scale(1.2);
            box-shadow: 0 14px 28px rgba(0, 0, 0, 0.35), 0 0 0 4px var(--logo-ring);
        }

        .portfolio-table-view {
            margin-top: 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
            flex: 1;
            align-content: start;
            padding: 0;
            width: 100%;
        }

        @media (max-width: 768px) {
            .portfolio-table-view {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
            }
        }

        @media (max-width: 480px) {
            .portfolio-table-view {
                grid-template-columns: 1fr;
            }
        }

        .card-collapsible-content {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            padding-top: 0;
            transition: max-height 0.35s ease, opacity 0.35s ease, padding-top 0.35s ease;
        }

        .collapsible-card.open .card-collapsible-content {
            opacity: 1;
            padding-top: 16px;
        }

        .hidden {
            display: none !important;
        }

        .earnings-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            margin-left: 8px;
            box-shadow: 0 0 0 2px #ffffff;
        }

        .earnings-badge[data-status="beat"] {
            background: #34c759;
        }

        .earnings-badge[data-status="miss"] {
            background: #ff3b30;
        }

        .earnings-badge[data-status="upcoming"] {
            background: #0a84ff;
        }

        .earnings-badge[data-status="neutral"] {
            background: rgba(142, 142, 147, 0.5);
        }

        body.dark .earnings-badge {
            box-shadow: 0 0 0 2px #1d1d1f;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .market-copy {
            font-size: 15px;
            line-height: 1.8;
            color: var(--text-secondary);
        }

        .market-insights-card {
            background: #ffffff;
            color: #1d1d1f;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        body.dark .market-insights-card {
            background: #2c2c2e;
            color: #f5f5f7;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .market-insights-toggle,
        .card-toggle {
            width: 100%;
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 20px;
            font-weight: 600;
            color: inherit;
            cursor: pointer;
            padding: 4px 0 8px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .market-insights-toggle-icon,
        .card-toggle-icon {
            transition: transform 0.3s ease;
            font-size: 20px;
        }

        .market-insights-card.open .market-insights-toggle-icon {
            transform: rotate(180deg);
        }

        .collapsible-card.open .card-toggle-icon {
            transform: rotate(180deg);
        }

        .market-insights-content {
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            transition: max-height 0.3s ease, opacity 0.2s ease, padding-top 0.3s ease;
        }

        .market-insights-card.open .market-insights-content {
            opacity: 1;
            padding-top: 12px;
        }

        .market-insights-card .market-copy {
            color: #1d1d1f;
            transition: none;
        }

        .market-insights-card .market-copy strong {
            color: #1d1d1f;
            transition: none;
        }

        body.dark .market-insights-card .market-copy,
        body.dark .market-insights-card .market-copy strong {
            color: #f5f5f7;
        }

        .market-insights-meta {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.4px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .market-clock-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: none;
        }

        .market-clock {
            padding: 4px 8px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.05);
        }

        body.dark .market-clock {
            background: rgba(255, 255, 255, 0.1);
        }

        .market-pulse {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
        }

        .market-pulse-item {
            background: rgba(0, 0, 0, 0.04);
            border-radius: 14px;
            padding: 18px 20px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-size: 18px;
            font-weight: 700;
        }

        .market-pulse-item span {
            display: block;
            margin-top: 8px;
            text-transform: none;
            letter-spacing: normal;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        body.dark .market-pulse-item {
            background: rgba(255, 255, 255, 0.06);
        }

        body.dark .market-pulse-item span {
            color: #d1d1d6;
        }

        .hidden-row {
            display: none;
        }

        .top-gain-badge {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            background: rgba(0, 122, 255, 0.12);
            color: var(--accent);
        }

        .top-gain-row td {
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.08), rgba(0, 122, 255, 0.02));
        }

        .payday-highlight {
            background: rgba(52, 199, 89, 0.1);
            border: 1px solid rgba(52, 199, 89, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .payday-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--success);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .payday-amount {
            font-size: 24px;
            font-weight: 700;
            color: var(--success);
            margin-bottom: 4px;
        }

        .payday-note {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .payday-date {
            font-size: 13px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 6px;
        }

        body.dark .payday-date {
            color: #f5f5f7;
        }

        .progress-summary {
            margin-bottom: 24px;
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .progress-labels span:nth-child(2) {
            color: var(--accent);
        }

        .progress-bar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            height: 20px;
            overflow: hidden;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .progress-bar-fill {
            background: rgba(0, 122, 255, 0.85);
            height: 100%;
            width: 24%;
            border-radius: 12px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        .heart {
            color: #ff3b30;
            animation: heartbeat 2s ease-in-out infinite;
            display: inline-block;
            vertical-align: middle;
        }

        @keyframes heartbeat {
            0% { transform: scale(1); }
            10% { transform: scale(1.2); }
            20% { transform: scale(1); }
            30% { transform: scale(1.15); }
            40% { transform: scale(1); }
            100% { transform: scale(1); }
        }

        /* Skeleton loading animation */
        @keyframes skeleton-pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }

        /* Calendar slide animation */
        @keyframes slideInRight {
            0% { transform: translateX(100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideInLeft {
            0% { transform: translateX(-100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        .skeleton {
            background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
            background-size: 200% 100%;
            animation: skeleton-pulse 1.5s ease-in-out infinite;
            border-radius: 4px;
            color: transparent !important;
        }

        /* Tab Navigation - Mobile First (bottom tabs) */
        .tab-navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            padding: 8px;
            gap: 4px;
            z-index: 1000;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.08);
        }

        body.dark .tab-navigation {
            background: rgba(28, 28, 30, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
        }

        .tab-btn {
            flex: 1;
            padding: 12px 8px;
            background: transparent;
            border: none;
            color: #86868b;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.2s ease;
        }

        .tab-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #1d1d1f;
        }

        body.dark .tab-btn {
            color: #98989d;
        }

        body.dark .tab-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #f5f5f7;
        }

        .tab-btn.active {
            background: rgba(0, 116, 217, 0.15);
            color: #0074D9;
        }

        body.dark .tab-btn.active {
            background: rgba(10, 132, 255, 0.25);
            color: #0a84ff;
        }

        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 100%;
            padding-bottom: 80px;
        }

        body.dark .skeleton {
            background: linear-gradient(90deg, #2c2c2e 25%, #3a3a3c 50%, #2c2c2e 75%);
        }
        .skeleton * { visibility: hidden; }

        /* Dynamic value indicator - subtle dot */
        .dynamic-value::before {
            content: '';
            display: inline-block;
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            margin-right: 6px;
            opacity: 0.7;
            animation: dynamic-pulse 2s ease-in-out infinite;
        }

        @keyframes dynamic-pulse {
            0%, 100% { opacity: 0.4; transform: scale(0.9); }
            50% { opacity: 0.8; transform: scale(1); }
        }

        body.dark .dynamic-value::before {
            background: #0a84ff;
        }

        .site-footer {
            display: none;
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #8e8e93;
            font-size: 14px;
        }

        .site-footer a {
            color: inherit;
            text-decoration: none;
            font-weight: 600;
        }

        .site-footer a:hover {
            text-decoration: underline;
        }

        h1 {
            color: #1d1d1f;
            font-size: 52px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -1px;
        }

        h2 {
            color: #6e6e73;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            letter-spacing: -0.2px;
        }

        table {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            background: transparent;
        }

        @media (max-width: 1024px) {
            table {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            table {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }
        }

        @media (max-width: 480px) {
            table {
                grid-template-columns: 1fr;
            }
        }

        thead {
            display: none;
        }

        tbody {
            display: contents;
        }

        th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #86868b;
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: color 0.2s ease;
        }

        th:hover {
            color: #0074D9;
        }

        th.sortable::after {
            content: ' ↕';
            opacity: 0.3;
            font-size: 10px;
        }

        th.sorted-asc::after {
            content: ' ↑';
            opacity: 1;
            color: #0074D9;
        }

        th.sorted-desc::after {
            content: ' ↓';
            opacity: 1;
            color: #0074D9;
        }

        tr {
            display: flex;
            flex-direction: column;
            background: transparent;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            padding: 12px 16px;
            gap: 6px;
            transition: all 0.3s ease;
            width: 100%;
        }

        tr:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        body.dark tr {
            background: transparent;
            border-color: rgba(255, 255, 255, 0.12);
            box-shadow: none;
        }

        body.dark tr:hover {
            background: rgba(255, 255, 255, 0.03);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        td {
            padding: 4px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            font-size: 14px;
            font-weight: 500;
        }

        td:first-child {
            border-top: none;
            padding-top: 0;
        }

        body.dark td {
            border-top-color: rgba(255, 255, 255, 0.12);
        }

        tbody tr {
            transition: background 0.15s ease, transform 0.15s ease;
        }
        tbody tr:hover {
            background: transparent;
        }

        tbody tr.active {
            background: transparent;
            border-color: rgba(0, 122, 255, 0.5);
        }

        body.dark tbody tr.active {
            background: transparent;
            border-color: rgba(10, 132, 255, 0.6);
        }

        tbody tr:last-child td {
            font-weight: 600;
        }

        a {
            color: #0074D9;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        a:hover {
            color: #0051d5;
        }

        .future-expense {
            opacity: 0.6;
            font-style: italic;
        }

        .earnings-badge {
            background: #0074D9;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 6px;
            font-weight: 600;
            margin-left: 4px;
            white-space: nowrap;
        }

        .earnings-badge.completed {
            background: #8e8e93;
        }

        .earnings-badge.upcoming-soon {
            background: #34c759;
        }

        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .glass-card {
                padding: 20px;
                border-radius: 16px;
            }

            h1 {
                font-size: 32px;
            }

            h2 {
                font-size: 22px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 10px 6px;
            }

            .back-button, .theme-toggle {
                width: 40px;
                height: 40px;
            }

            .site-header {
                padding: 12px;
                gap: 8px;
            }

            .brand-badge {
                padding: 0 10px;
                height: 40px;
                gap: 6px;
            }

            .brand-name {
                font-size: 16px;
            }

            .brand-tagline {
                font-size: 11px;
            }

            .portfolio-pie-view {
                flex-direction: column;
                align-items: center;
            }

            .pie-chart-wrapper {
                width: 320px;
                height: 320px;
            }

            .pie-chart {
                width: 320px;
                height: 320px;
            }

            .pie-chart canvas {
                width: 320px;
                height: 320px;
            }

            .pie-center-label {
                min-width: 140px;
                font-size: 22px;
            }

            .chart-legend {
                width: 100%;
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }

            .market-pulse {
                grid-template-columns: 1fr;
            }

            .market-clock-grid {
                flex-direction: column;
                align-items: flex-start;
            }

            .view-toggle {
                padding: 6px;
            }

            .view-toggle button {
                font-size: 15px;
                padding: 10px 18px;
                min-height: 44px;
            }

            .pie-chart canvas {
                width: 220px;
                height: 220px;
            }
        }

        /* Pull to refresh */
        .pull-indicator {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%) translateY(-60px);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
            z-index: 9999;
            pointer-events: none;
        }
        body.dark .pull-indicator {
            background: rgba(44, 44, 46, 0.95);
        }
        .pull-indicator.visible {
            transform: translateX(-50%) translateY(20px);
        }
        .pull-indicator.refreshing {
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            from { transform: translateX(-50%) translateY(20px) rotate(0deg); }
            to { transform: translateX(-50%) translateY(20px) rotate(360deg); }
        }
        .pull-indicator svg {
            width: 20px;
            height: 20px;
            fill: #0074D9;
        }

        #pwdToggle {
            appearance: none;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0, 200, 5, 0.4);
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        #pwdToggle:checked {
            background: #00C805;
            border-color: #00C805;
        }

        #pwdToggle:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        #pwdToggle:hover {
            border-color: #00C805;
            box-shadow: 0 0 0 3px rgba(0, 200, 5, 0.1);
        }

        body.dark #pwdToggle {
            border-color: rgba(0, 200, 5, 0.5);
        }

    </style>
</head>
<body>
    <script>
        const holdingsConfig = [
            {
                symbol: 'DIS',
                quoteSymbol: 'DIS',
                logoLabel: 'DIS',
                logoSvg: '<svg viewBox="0 0 32 32" fill="currentColor"><text x="16" y="21" text-anchor="middle" font-size="10" font-weight="bold" font-family="Arial, sans-serif" letter-spacing="-0.5">DIS</text></svg>',
                shares: 0.0464,
                targetPrice: 150,
                fallbackPrice: 107.40,
                fallbackDailyChange: +2.06,
                color: '#113CCF',
                url: 'https://finance.yahoo.com/quote/DIS',
                earningsStatus: 'neutral',
                earningsLabel: 'Walt Disney Co'
            },
            {
                symbol: 'NVDA',
                quoteSymbol: 'NVDA',
                logoLabel: 'NV',
                logoSvg: '<svg viewBox="0 0 32 32" fill="currentColor"><text x="16" y="21" text-anchor="middle" font-size="10" font-weight="bold" font-family="Arial, sans-serif" letter-spacing="-0.5">NVDA</text></svg>',
                shares: 1.0169,
                targetPrice: 390,
                fallbackPrice: 183.13,
                fallbackDailyChange: +0.39,
                color: '#9dd866',
                url: 'https://finance.yahoo.com/quote/NVDA',
                earningsStatus: 'beat',
                earningsLabel: 'NVIDIA Corp'
            },
            {
                symbol: 'IREN',
                quoteSymbol: 'IREN',
                logoLabel: 'IREN',
                logoSvg: '<svg viewBox="0 0 32 32" fill="currentColor"><text x="16" y="21" text-anchor="middle" font-size="9" font-weight="bold" font-family="Arial, sans-serif" letter-spacing="-0.5">IREN</text></svg>',
                shares: 0.2215,
                targetPrice: 100,
                fallbackPrice: 45.00,
                fallbackDailyChange: +0.65,
                color: '#FF6B35',
                url: 'https://finance.yahoo.com/quote/IREN',
                earningsStatus: 'neutral',
                earningsLabel: 'IREN Limited'
            },
            {
                symbol: 'KODK',
                quoteSymbol: 'KODK',
                logoLabel: 'KODK',
                logoSvg: '<svg viewBox="0 0 32 32" fill="currentColor"><text x="16" y="21" text-anchor="middle" font-size="9" font-weight="bold" font-family="Arial, sans-serif" letter-spacing="-0.5">KODK</text></svg>',
                shares: 1,
                targetPrice: 15,
                fallbackPrice: 9.55,
                fallbackDailyChange: +8.65,
                color: '#FDB913',
                url: 'https://finance.yahoo.com/quote/KODK',
                earningsStatus: 'neutral',
                earningsLabel: 'Eastman Kodak'
            },
            {
                symbol: 'HOOD',
                quoteSymbol: 'HOOD',
                logoLabel: 'H',
                logoSvg: '<svg viewBox="0 0 32 32" fill="currentColor"><text x="16" y="21" text-anchor="middle" font-size="11" font-weight="bold" font-family="Arial, sans-serif" letter-spacing="-0.5">HOOD</text></svg>',
                shares: 0.3039,
                targetPrice: 160,
                fallbackPrice: 136.44,
                fallbackDailyChange: +3.40,
                color: '#00C805',
                url: 'https://finance.yahoo.com/quote/HOOD',
                earningsStatus: 'neutral',
                earningsLabel: 'Robinhood Markets'
            },
            {
                symbol: 'GOOGL',
                quoteSymbol: 'GOOGL',
                logoLabel: 'G',
                logoSvg: '<svg viewBox="0 0 32 32" fill="white"><circle cx="16" cy="16" r="14" fill="white"/><path fill="#4285F4" d="M16.3 13.5v3.4h5.6c-.2 1.4-1.6 4-5.6 4-3.4 0-6.2-2.8-6.2-6.2s2.8-6.2 6.2-6.2c1.9 0 3.2.8 4 1.5l2.7-2.6C21.4 5.9 19.1 4.8 16.3 4.8c-5.6 0-10.2 4.5-10.2 10.2s4.5 10.2 10.2 10.2c5.9 0 9.8-4.1 9.8-10 0-.7-.1-1.2-.2-1.7h-9.6z"/></svg>',
                shares: 0.3322,
                targetPrice: 400,
                fallbackPrice: 312.76,
                fallbackDailyChange: -2.65,
                color: '#4285F4',
                url: 'https://finance.yahoo.com/quote/GOOGL',
                earningsStatus: 'neutral',
                earningsLabel: 'Alphabet Inc'
            },
            {
                symbol: 'SPY',
                quoteSymbol: 'SPY',
                logoLabel: 'SP',
                logoSvg: '<svg viewBox="0 0 32 32" fill="currentColor"><text x="16" y="20" text-anchor="middle" font-size="14" font-weight="bold" font-family="Arial, sans-serif">S&P</text></svg>',
                shares: 0.1155,
                targetPrice: 1100,
                fallbackPrice: 683.20,
                fallbackDailyChange: -0.36,
                color: '#4f75b7',
                url: 'https://finance.yahoo.com/quote/SPY',
                earningsStatus: 'neutral',
                earningsLabel: 'S&P 500 ETF'
            },
            {
                symbol: 'SLV',
                quoteSymbol: 'SLV',
                logoLabel: 'SL',
                logoSvg: '<svg viewBox="0 0 32 32" fill="currentColor"><text x="16" y="21" text-anchor="middle" font-size="10" font-weight="bold" font-family="Arial, sans-serif" letter-spacing="-0.5">SLV</text></svg>',
                shares: 1.3204,
                targetPrice: 60,
                fallbackPrice: 52.69,
                fallbackDailyChange: -0.49,
                color: '#C0C0C0',
                url: 'https://finance.yahoo.com/quote/SLV',
                earningsStatus: 'neutral',
                earningsLabel: 'iShares Silver Trust'
            },
            {
                symbol: 'NFLX',
                quoteSymbol: 'NFLX',
                logoLabel: 'N',
                logoSvg: '<svg viewBox="0 0 32 32" fill="currentColor"><text x="16" y="21" text-anchor="middle" font-size="11" font-weight="bold" font-family="Arial, sans-serif" letter-spacing="-0.5">NFLX</text></svg>',
                shares: 0.508,
                targetPrice: 150,
                fallbackPrice: 95.90,
                fallbackDailyChange: -4.33,
                color: '#E50914',
                url: 'https://finance.yahoo.com/quote/NFLX',
                earningsStatus: 'neutral',
                earningsLabel: 'Netflix Inc'
            },
            {
                symbol: 'XIU',
                quoteSymbol: 'XIU.TO',
                logoLabel: 'XIU',
                logoSvg: '<svg viewBox="0 0 32 32" fill="currentColor"><text x="16" y="21" text-anchor="middle" font-size="10" font-weight="bold" font-family="Arial, sans-serif" letter-spacing="-0.5">XIU</text></svg>',
                shares: 1.0671,
                targetPrice: 60,
                fallbackPrice: 46.20,
                fallbackDailyChange: -0.48,
                color: '#5A8FD3',
                url: 'https://finance.yahoo.com/quote/XIU.TO',
                earningsStatus: 'neutral',
                earningsLabel: 'iShares S&P/TSX 60',
                currency: 'CAD'
            },
            {
                symbol: 'CASH',
                quoteSymbol: 'CASH',
                logoLabel: '$',
                logoSvg: '<svg viewBox="0 0 32 32" fill="currentColor"><text x="16" y="22" text-anchor="middle" font-size="16" font-weight="bold" font-family="Arial, sans-serif">$</text></svg>',
                shares: 45790,
                targetPrice: 0.01,
                fallbackPrice: 0.01,
                fallbackDailyChange: 0,
                color: '#d1d1d6',
                url: '#',
                earningsStatus: 'neutral',
                earningsLabel: 'CAD cash ($0.01 CAD)'
            }
        ];

        let holdingsData = [];

        const FINANCIAL_CONFIG = {
            cadSavings: 0,  // Stocks are held in TFSA, already counted
            cadToUsdRate: 0.72,
            debtGoal: 5500,  // RBC VISA credit card debt (settle in 2025)
            monthlyPaymentCapacity: 476
        };

        const formatCurrency = (value, currency = 'USD', fractionDigits = 0) => {
            const numericValue = Number.isFinite(value) ? value : 0;
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency,
                minimumFractionDigits: fractionDigits,
                maximumFractionDigits: fractionDigits
            }).format(Math.round(numericValue));
        };
        const formatPrice = (value, currency = 'USD') => {
            const numericValue = Number.isFinite(value) ? value : 0;
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency,
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(numericValue);
        };
        const formatShares = (value) => {
            const fixed = value.toFixed(4);
            return fixed.replace(/\.?0+$/, '');
        };
        const formatPercent = (value) => {
            const numericValue = Number.isFinite(value) ? value : 0;
            const sign = numericValue > 0 ? '+' : '';
            return `${sign}${numericValue.toFixed(1)}%`;
        };

        // Flipboard-style counter - digits scramble then settle
        const animateValue = (element, endValue, duration = 800, currency = 'USD', suffix = '') => {
            if (!element) return;
            element.classList.remove('skeleton');
            const targetStr = formatCurrency(endValue, currency) + suffix;
            const chars = targetStr.split('');
            const startTime = performance.now();

            const scramble = (progress) => {
                const result = chars.map((char, i) => {
                    if (!/\d/.test(char)) return char;
                    // Each digit settles at different times (cascade effect)
                    const settlePoint = 0.3 + (i * 0.05);
                    if (progress >= settlePoint) return char;
                    return Math.floor(Math.random() * 10);
                }).join('');
                return result;
            };

            const animate = (currentTime) => {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                element.textContent = progress < 1 ? scramble(progress) : targetStr;
                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            };
            requestAnimationFrame(animate);
        };

        // Flipboard animate with HTML suffix
        const animateValueHTML = (element, endValue, duration = 800, currency = 'USD', suffixHTML = '') => {
            if (!element) return;
            const targetStr = formatCurrency(endValue, currency);
            const chars = targetStr.split('');
            const startTime = performance.now();

            const scramble = (progress) => {
                const result = chars.map((char, i) => {
                    if (!/\d/.test(char)) return char;
                    const settlePoint = 0.3 + (i * 0.05);
                    if (progress >= settlePoint) return char;
                    return Math.floor(Math.random() * 10);
                }).join('');
                return result;
            };

            const animate = (currentTime) => {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                element.innerHTML = (progress < 1 ? scramble(progress) : targetStr) + suffixHTML;
                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            };
            requestAnimationFrame(animate);
        };

        // Haptic feedback helper (global)
        const haptic = (style = 'light') => {
            if (navigator.vibrate) {
                const patterns = { light: 10, medium: 20, heavy: 30 };
                navigator.vibrate(patterns[style] || 10);
            }
        };

        const getContrastColor = (hex) => {
            const clean = hex.replace('#', '');
            const expanded = clean.length === 3 ? clean.split('').map(ch => ch + ch).join('') : clean;
            const r = parseInt(expanded.substring(0, 2), 16);
            const g = parseInt(expanded.substring(2, 4), 16);
            const b = parseInt(expanded.substring(4, 6), 16);
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance > 0.6 ? '#1d1d1f' : '#f5f5f7';
        };

        function buildHoldings(quoteMap = {}) {
            return holdingsConfig
                .filter(item => item.shares > 0)
                .map(item => {
                    const quote = quoteMap[item.quoteSymbol || item.symbol];
                    const price = quote?.regularMarketPrice ?? item.fallbackPrice ?? 0;
                    const dailyChangePercent = quote?.regularMarketChangePercent ?? item.fallbackDailyChange ?? 0;
                    const currency = quote?.currency || 'USD';
                    const currentValue = price * item.shares;
                    const targetValue = item.targetPrice * item.shares;
                    const gainPercent = price > 0 ? ((item.targetPrice - price) / price) * 100 : 0;
                    return {
                        ...item,
                        url: item.url || `https://finance.yahoo.com/quote/${item.quoteSymbol || item.symbol}`,
                        price,
                        currency,
                        dailyChangePercent,
                        currentValue,
                        targetValue,
                        gainPercent
                    };
                });
        }

        async function loadHoldings() {
            try {
                // Try to fetch live prices from API
                const response = await fetch('/api/stocks');
                if (response.ok) {
                    const data = await response.json();
                    return buildHoldings(data.quotes);
                }
            } catch (error) {
                console.log('Using fallback prices:', error);
            }
            // Fallback to static prices if API fails
            return buildHoldings();
        }

        const formatMonthYear = (date) => date.toLocaleString('en-US', { month: 'long', year: 'numeric' });

        function updateFinancialSections(currentTotal, targetTotal) {
            const cadUsdValue = FINANCIAL_CONFIG.cadSavings * FINANCIAL_CONFIG.cadToUsdRate;
            const totalAssetsUsd = currentTotal + cadUsdValue;
            const remainingToGoal = Math.max(FINANCIAL_CONFIG.debtGoal - totalAssetsUsd, 0);
            const savedPercent = FINANCIAL_CONFIG.debtGoal > 0 ? (totalAssetsUsd / FINANCIAL_CONFIG.debtGoal) * 100 : 0;
            const progressLabels = document.querySelectorAll('.progress-labels span');
            if (progressLabels[0]) progressLabels[0].textContent = formatCurrency(0);
            if (progressLabels[1]) {
                const savedLabel = `${formatCurrency(totalAssetsUsd)} saved (${Math.round(Math.min(savedPercent, 100))}%)`;
                progressLabels[1].textContent = savedLabel;
            }
            if (progressLabels[2]) progressLabels[2].textContent = formatCurrency(FINANCIAL_CONFIG.debtGoal);

            const progressFill = document.querySelector('.progress-bar-fill');
            if (progressFill) {
                const clampedPercent = Math.max(0, Math.min(savedPercent, 100));
                progressFill.style.width = `${clampedPercent.toFixed(1)}%`;
            }

            const totalAssetsCell = document.getElementById('totalAssetsCell');
            if (totalAssetsCell) {
                totalAssetsCell.textContent = `${formatCurrency(currentTotal)} USD + ${formatCurrency(FINANCIAL_CONFIG.cadSavings, 'CAD')} (~${formatCurrency(cadUsdValue)} USD) = ~${formatCurrency(totalAssetsUsd)} USD`;
            }

            const remainingCell = document.getElementById('remainingToGoalCell');
            if (remainingCell) {
                remainingCell.textContent = remainingToGoal > 0 ? formatCurrency(remainingToGoal) : 'Goal reached 🎉';
            }

            const monthsToGoal = remainingToGoal > 0 ? remainingToGoal / FINANCIAL_CONFIG.monthlyPaymentCapacity : 0;
            const monthsCell = document.getElementById('monthsToDebtFreeCell');
            if (monthsCell) {
                monthsCell.textContent = monthsToGoal > 0 ? `${monthsToGoal.toFixed(1)} months` : 'Paid off';
            }

            const debtFreeDateCell = document.getElementById('debtFreeDateCell');
            let projectedPayoffLabel = 'now';
            if (monthsToGoal > 0) {
                const payoffDate = new Date();
                payoffDate.setMonth(payoffDate.getMonth() + Math.ceil(monthsToGoal));
                projectedPayoffLabel = formatMonthYear(payoffDate);
                if (debtFreeDateCell) {
                    debtFreeDateCell.textContent = projectedPayoffLabel;
                }
            } else if (debtFreeDateCell) {
                debtFreeDateCell.textContent = 'You did it 🎉';
            }

            const summaryTotal = document.getElementById('summaryTotalPortfolio');
            if (summaryTotal) animateValue(summaryTotal, currentTotal, 1000);

            const summaryTarget = document.getElementById('summaryTargetPortfolio');
            if (summaryTarget) animateValue(summaryTarget, targetTotal, 1000);

            const summaryGain = document.getElementById('summaryPotentialGain');
            if (summaryGain) {
                const gainDelta = targetTotal - currentTotal;
                const gainPercent = currentTotal > 0 ? (gainDelta / currentTotal) * 100 : 0;
                const sign = gainDelta >= 0 ? '+' : '-';
                summaryGain.textContent = `${sign}${formatCurrency(Math.abs(gainDelta))} (${sign}${Math.abs(Math.round(gainPercent))}%)`;
            }

            const summaryNetWorth = document.getElementById('summaryNetWorth');
            if (summaryNetWorth) {
                const netWorth = totalAssetsUsd - FINANCIAL_CONFIG.debtGoal;
                summaryNetWorth.textContent = `${formatCurrency(totalAssetsUsd)} - ${formatCurrency(FINANCIAL_CONFIG.debtGoal)} = ${formatCurrency(netWorth)}`;
            }

            // Calculate portfolio milestones
            const milestonesTable = document.getElementById('milestonesTable');
            if (milestonesTable) {
                const currentPortfolio = totalAssetsUsd;
                const monthlyInvestment = 476; // Current monthly capacity
                const annualReturn = 0.15; // 15% conservative estimate
                const milestones = [1000, 2000, 5000, 13000, 34000, 89000, 233000, 987000];

                let html = '';
                for (const milestone of milestones) {
                    if (currentPortfolio >= milestone || milestone === 1000) {
                        const label = milestone >= 1000000 ? `$${(milestone/1000000).toFixed(0)}M` : `$${(milestone/1000).toFixed(0)}K`;
                        html += `<tr><td><strong>${label}</strong></td><td style="color: #4ade80;">Achieved!</td></tr>`;
                    } else {
                        // Calculate months to milestone with compound growth
                        const futureValue = milestone;
                        const presentValue = currentPortfolio;
                        const payment = monthlyInvestment;
                        const monthlyRate = annualReturn / 12;

                        // FV = PV(1+r)^n + PMT * [((1+r)^n - 1) / r]
                        // Solve for n using approximation
                        let n = 0;
                        let value = presentValue;
                        while (value < futureValue && n < 600) { // max 50 years
                            value = value * (1 + monthlyRate) + payment;
                            n++;
                        }

                        const monthsNeeded = n;
                        const targetDate = new Date();
                        targetDate.setMonth(targetDate.getMonth() + monthsNeeded);
                        const dateStr = targetDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                        const label = milestone >= 1000000 ? `$${(milestone/1000000).toFixed(0)}M` : `$${(milestone/1000).toFixed(0)}K`;

                        html += `<tr><td><strong>${label}</strong></td><td>${dateStr} (${monthsNeeded}mo)</td></tr>`;
                    }
                }
                milestonesTable.innerHTML = html;
            }

            return {
                totalAssetsUsd,
                cadUsdValue,
                remainingToGoal,
                monthsToGoal,
                debtFreeLabel: projectedPayoffLabel
            };
        }

        function initSlideToggle({ toggle, content, card, defaultOpen = false }) {
            if (!toggle || !content) return;
            const hostCard = card || content.closest('.glass-card');

            const expand = () => {
                if (content._expandTimer) clearTimeout(content._expandTimer);
                content.style.overflow = 'visible';
                content.style.maxHeight = `${content.scrollHeight}px`;
                content._expandTimer = setTimeout(() => {
                    if (toggle.getAttribute('aria-expanded') === 'true') {
                        content.style.maxHeight = 'none';
                    }
                }, 400);
            };

            const collapse = () => {
                if (content._expandTimer) clearTimeout(content._expandTimer);
                content.style.overflow = 'hidden';
                if (content.style.maxHeight === 'none') {
                    content.style.maxHeight = `${content.scrollHeight}px`;
                    void content.offsetHeight;
                }
                content.style.maxHeight = '0px';
            };

            const setState = (expanded) => {
                toggle.setAttribute('aria-expanded', String(expanded));
                content.setAttribute('aria-hidden', String(!expanded));
                if (hostCard) {
                    hostCard.classList.toggle('open', expanded);
                }
                if (expanded) {
                    expand();
                } else {
                    collapse();
                }
            };

            setState(defaultOpen);

            const handleToggle = () => {
                const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
                setState(!isExpanded);
            };
            toggle.addEventListener('click', handleToggle);
            toggle.addEventListener('touchend', (e) => {
                e.preventDefault();
                handleToggle();
            });

            window.addEventListener('resize', () => {
                if (toggle.getAttribute('aria-expanded') === 'true') {
                    if (content.style.maxHeight === 'none') {
                        content.style.maxHeight = `${content.scrollHeight}px`;
                        content._expandTimer = setTimeout(() => {
                            if (toggle.getAttribute('aria-expanded') === 'true') {
                                content.style.maxHeight = 'none';
                            }
                        }, 400);
                    } else {
                        content.style.maxHeight = `${content.scrollHeight}px`;
                    }
                }
            });
        }

        const MARKET_TZ = 'America/Los_Angeles';

        function getMarketSessionInfo(now = new Date()) {
            const openHour = 6; // 6:30 AM PST
            const openMinute = 30;
            const closeHour = 13; // 1:00 PM PST
            const closeMinute = 0;
            const open = new Date(now.toLocaleString('en-US', { timeZone: MARKET_TZ }));
            open.setHours(openHour, openMinute, 0, 0);
            const close = new Date(now.toLocaleString('en-US', { timeZone: MARKET_TZ }));
            close.setHours(closeHour, closeMinute, 0, 0);
            const beforeOpen = now < open;
            const afterClose = now > close;
            const status = beforeOpen ? 'PRE' : afterClose ? 'POST' : 'OPEN';
            const target = beforeOpen ? open : afterClose ? open.setDate(open.getDate() + 1) && open : close;
            const remainingMs = target - now;
            const remaining = remainingMs > 0 ? {
                hours: Math.floor(remainingMs / (1000 * 60 * 60)),
                minutes: Math.floor((remainingMs / (1000 * 60)) % 60),
                seconds: Math.floor((remainingMs / 1000) % 60),
                label: beforeOpen ? 'opens' : afterClose ? 'next open' : 'closes'
            } : null;
            return { status, remaining };
        }

        let marketCountdownTimer = null;
        let marketClockTimer = null;

        function updateMarketInsights(financialSnapshot = {}) {
            const list = document.getElementById('marketPulseList');
            if (!list) return;
            const timestampLabel = document.getElementById('marketInsightsTimestamp');
            const renderClocks = () => {
                const pstClock = document.getElementById('pstClock');
                const estClock = document.getElementById('estClock');
                if (!pstClock || !estClock) return;
                const now = new Date();
                const pst = new Date(now.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
                const est = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
                pstClock.textContent = `PST — ${pst.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}`;
                estClock.textContent = `EST — ${est.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}`;
            };

            const renderTimestamp = () => {
                if (!timestampLabel) return;
                const now = new Date();
                const pacificNow = new Date(now.toLocaleString('en-US', { timeZone: MARKET_TZ }));
                const dateLabel = pacificNow.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                const timeLabel = pacificNow.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                const session = getMarketSessionInfo(pacificNow);
                const countdownText = session.remaining
                    ? ` · ${session.remaining.label} in ${session.remaining.hours}h ${session.remaining.minutes}m`
                    : '';
                const sessionLabel = session.status === 'OPEN' ? 'market live' : session.status === 'PRE' ? 'pre-market' : 'after hours';
                timestampLabel.textContent = `${dateLabel} · ${timeLabel} PST · ${sessionLabel}${countdownText}`;
            };
            if (timestampLabel) {
                renderTimestamp();
                if (marketCountdownTimer) clearTimeout(marketCountdownTimer);
                const scheduleTick = () => {
                    renderTimestamp();
                    marketCountdownTimer = setTimeout(scheduleTick, 60000);
                };
                marketCountdownTimer = setTimeout(scheduleTick, 60000);
                renderClocks();
                if (marketClockTimer) clearTimeout(marketClockTimer);
                const scheduleClock = () => {
                    renderClocks();
                    marketClockTimer = setTimeout(scheduleClock, 60000);
                };
                marketClockTimer = setTimeout(scheduleClock, 60000);
            }
            if (!holdingsData.length) return;
            const movers = [...holdingsData].sort((a, b) => b.dailyChangePercent - a.dailyChangePercent);
            const topMover = movers[0];
            const laggard = movers.length > 1 ? movers[movers.length - 1] : movers[0];
            const upside = holdingsData.reduce((best, item) => (item.gainPercent > best.gainPercent ? item : best), holdingsData[0]);
            const remaining = financialSnapshot.remainingToGoal ?? null;
            const debtEta = financialSnapshot.debtFreeLabel;
            const payoffLine = remaining !== null
                ? remaining > 0
                    ? `${formatCurrency(remaining)} to go · pacing ${debtEta} with ${formatCurrency(FINANCIAL_CONFIG.monthlyPaymentCapacity)}/mo`
                    : `Goal funded · redeploy ${formatCurrency(FINANCIAL_CONFIG.monthlyPaymentCapacity)}/mo`
                : `Keep ${formatCurrency(FINANCIAL_CONFIG.monthlyPaymentCapacity)}/mo on autopay`;
            const upsidePercent = Math.max(Math.round(upside.gainPercent), 0);
            const downsidePercent = Math.min(Math.round(laggard.dailyChangePercent), 0);
            const portfolioDailyChange = holdingsData.reduce((sum, h) => sum + (h.currentValue * h.dailyChangePercent / 100), 0);
            const portfolioDailyPercent = holdingsData.reduce((sum, h) => sum + h.currentValue, 0) > 0
                ? (portfolioDailyChange / holdingsData.reduce((sum, h) => sum + h.currentValue, 0)) * 100
                : 0;
            const insights = [
                {
                    title: 'TODAY',
                    detail: `Portfolio ${portfolioDailyPercent >= 0 ? '+' : ''}${portfolioDailyPercent.toFixed(2)}% · ${topMover.symbol} led at ${formatPercent(topMover.dailyChangePercent)}${topMover.earningsLabel ? ` (${topMover.earningsLabel})` : ''}`
                },
                {
                    title: 'SPREAD',
                    detail: `${topMover.symbol} ${formatPercent(topMover.dailyChangePercent)} to ${laggard.symbol} ${formatPercent(laggard.dailyChangePercent)} · ${Math.abs(topMover.dailyChangePercent - laggard.dailyChangePercent).toFixed(1)}pp range`
                },
                {
                    title: 'TARGETS',
                    detail: `${upside.symbol} ${upsidePercent}% to target · ${payoffLine}`
                }
            ];
            list.innerHTML = '';
            insights.forEach(item => {
                const block = document.createElement('div');
                block.className = 'market-pulse-item';
                block.textContent = item.title;
                const detail = document.createElement('span');
                detail.textContent = item.detail;
                block.appendChild(detail);
                list.appendChild(block);
            });
        }

        let isPWDMode = false;
        let scrollListenersInitialized = false;
        let currentMonthIndex = 0;

        function generateBudgetCalendar(usePWD = false) {
            const monthsContainer = document.getElementById('calendarMonths');
            const legendContainer = document.getElementById('calendarLegend');
            if (!monthsContainer || !legendContainer) return;

            const baseIncome = 1113;
            const pwdIncome = Math.round(baseIncome * 1.4);
            const expenses = 637;
            const monthlySurplus = usePWD ? (pwdIncome - expenses) : FINANCIAL_CONFIG.monthlyPaymentCapacity;
            const currentAssets = 931;

            const desc = document.getElementById('timelineDescription');
            if (desc) {
                desc.textContent = usePWD ? `PWD income: $${monthlySurplus}/month surplus` : `Current income: $476/month surplus`;
            }

            // Sorted by priority: cheap items first, then expensive
            const budgetItems = [
                { name: 'Drain Snake', cost: 15, priority: 1, color: '#8e8e93' },
                { name: 'Keyboard', cost: 120, priority: 2, color: '#34c759' },
                { name: 'Door Lock', cost: 85, priority: 3, color: '#32ade6' },
                { name: 'iPhone 17 + Watch', cost: 330, priority: 4, color: '#ff6b6b' },
                { name: 'GBA', cost: 320, priority: 5, color: '#00C805' },
                { name: 'iPhone 15 Final Bill', cost: 617, priority: 6, color: '#5856d6' },
                { name: 'Gold Chain', cost: 2500, priority: 7, color: '#ffd700' },
                { name: 'MacBook', cost: 4200, priority: 8, color: '#007AFF' },
                { name: 'Dog', cost: 5000, priority: 9, color: '#ff9500' },
                { name: 'RBC Visa', cost: 5500, priority: 10, color: '#ff4444' }
            ];

            const timeline = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Sequential timeline with manual dates for quick purchases
            let cumulativeSavings = currentAssets;
            let currentDate = new Date(today);

            budgetItems.forEach(item => {
                let availableDate;

                // Manual dates for items buying soon (spread across next 2 weeks)
                if (item.name === 'Drain Snake') {
                    // Dec 4 (Wed)
                    availableDate = new Date(today);
                    availableDate.setDate(availableDate.getDate() + 1);
                    timeline.push({ ...item, availableDate, monthsAway: 0 });
                    cumulativeSavings -= item.cost;
                } else if (item.name === 'Keyboard') {
                    // Dec 11 (Wed) - next week
                    availableDate = new Date(today);
                    availableDate.setDate(availableDate.getDate() + 8);
                    timeline.push({ ...item, availableDate, monthsAway: 0 });
                    cumulativeSavings -= item.cost;
                } else if (item.name === 'Door Lock') {
                    // Dec 9 (Mon)
                    availableDate = new Date(today);
                    availableDate.setDate(availableDate.getDate() + 6);
                    timeline.push({ ...item, availableDate, monthsAway: 0 });
                    cumulativeSavings -= item.cost;
                } else if (item.name === 'iPhone 17 + Watch') {
                    // Dec 10 (Tue)
                    availableDate = new Date(today);
                    availableDate.setDate(availableDate.getDate() + 7);
                    timeline.push({ ...item, availableDate, monthsAway: 0 });
                    cumulativeSavings -= item.cost;
                } else if (item.name === 'GBA') {
                    // Dec 12 (Thu)
                    availableDate = new Date(today);
                    availableDate.setDate(availableDate.getDate() + 9);
                    timeline.push({ ...item, availableDate, monthsAway: 0 });
                    cumulativeSavings -= item.cost;
                } else if (item.name === 'iPhone 15 Final Bill') {
                    // Dec 17 (Tue)
                    availableDate = new Date(today);
                    availableDate.setDate(availableDate.getDate() + 14);
                    timeline.push({ ...item, availableDate, monthsAway: 0 });
                    cumulativeSavings -= item.cost;
                } else if (cumulativeSavings >= item.cost) {
                    // Can afford it with current savings
                    timeline.push({ ...item, availableDate: new Date(currentDate), monthsAway: 0 });
                    cumulativeSavings -= item.cost;
                } else {
                    // Need to save for it
                    const remaining = item.cost - cumulativeSavings;
                    const monthsNeeded = Math.ceil(remaining / monthlySurplus);
                    currentDate.setMonth(currentDate.getMonth() + monthsNeeded);
                    timeline.push({ ...item, availableDate: new Date(currentDate), monthsAway: monthsNeeded });
                    cumulativeSavings = (monthsNeeded * monthlySurplus) - remaining;
                }
            });

            // Generate 12 months starting from today
            const months = [];
            for (let i = 0; i < 12; i++) {
                const monthDate = new Date(today.getFullYear(), today.getMonth() + i, 1);
                months.push(monthDate);
            }

            // Build calendar HTML for current month only
            const monthStart = months[currentMonthIndex];
            const monthName = monthStart.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            const daysInMonth = new Date(monthStart.getFullYear(), monthStart.getMonth() + 1, 0).getDate();
            const firstDay = monthStart.getDay();

            let daysHTML = '';

            // Empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                daysHTML += '<div></div>';
            }

            // Actual days
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(monthStart.getFullYear(), monthStart.getMonth(), day);
                date.setHours(0, 0, 0, 0);

                // Find items available on this day
                const itemsToday = timeline.filter(t => {
                    const tDate = new Date(t.availableDate);
                    tDate.setHours(0, 0, 0, 0);
                    return tDate.getTime() === date.getTime();
                });

                const isToday = date.getTime() === today.getTime();
                const bgColor = itemsToday.length > 0 ? itemsToday[0].color : (isToday ? 'rgba(0,200,5,0.2)' : 'transparent');
                const textColor = itemsToday.length > 0 ? '#fff' : (isToday ? '#00C805' : '#888');

                // Show all items with prices
                let itemLabel = '';
                if (itemsToday.length === 1) {
                    itemLabel = `${itemsToday[0].name}<br><span style="font-size:8px;opacity:0.9">$${itemsToday[0].cost}</span>`;
                } else if (itemsToday.length > 1) {
                    itemLabel = itemsToday.map(item => `${item.name} $${item.cost}`).join('<br>');
                }

                daysHTML += `<div style="background:${bgColor};color:${textColor};padding:12px;border-radius:8px;text-align:center;min-height:70px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:${isToday ? '700' : '500'}">
                    <div style="font-size:18px">${day}</div>
                    ${itemLabel ? `<div style="font-size:9px;font-weight:700;margin-top:4px;text-transform:uppercase;line-height:1.3">${itemLabel}</div>` : ''}
                </div>`;
            }

            const calendarHTML = `
                <div style="background:rgba(255,255,255,0.04);border-radius:12px;padding:24px;width:100%">
                    <div style="font-weight:700;font-size:20px;text-align:center;margin-bottom:16px;color:#fff">${monthName}</div>
                    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;font-size:12px;color:#666;margin-bottom:12px;text-align:center">
                        <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px">
                        ${daysHTML}
                    </div>
                </div>
            `;

            // Add slide animation (use global variable to track direction)
            const slideDirection = window.calendarDirection || 'right';
            monthsContainer.style.animation = slideDirection === 'right' ? 'slideInRight 0.3s ease-out' : 'slideInLeft 0.3s ease-out';
            monthsContainer.innerHTML = calendarHTML;
            setTimeout(() => monthsContainer.style.animation = '', 300);

            // Legend
            legendContainer.innerHTML = `<div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center">${timeline.map(item =>
                `<div style="display:inline-flex;align-items:center;gap:5px;padding:4px 10px;background:${item.color}15;border:1px solid ${item.color}40;border-radius:6px">
                    <div style="width:10px;height:10px;background:${item.color};border-radius:2px"></div>
                    <span style="font-size:11px;font-weight:600;color:#fff">${item.name}</span>
                    <span style="font-size:10px;color:#888">$${item.cost.toLocaleString()}</span>
                </div>`
            ).join('')}</div>`;

            // Month navigation buttons and scroll gestures (attach once)
            if (!scrollListenersInitialized) {
                const prevBtn = document.getElementById('scrollStart');
                const nextBtn = document.getElementById('scrollEnd');
                const calendarContainer = document.getElementById('budgetCalendar');

                if (prevBtn) {
                    prevBtn.onclick = () => {
                        if (currentMonthIndex > 0) {
                            window.calendarDirection = 'left';
                            currentMonthIndex--;
                            generateBudgetCalendar(isPWDMode);
                        }
                    };
                }
                if (nextBtn) {
                    nextBtn.onclick = () => {
                        if (currentMonthIndex < 11) {
                            window.calendarDirection = 'right';
                            currentMonthIndex++;
                            generateBudgetCalendar(isPWDMode);
                        }
                    };
                }

                // Horizontal scroll/swipe support
                if (calendarContainer) {
                    let scrollTimeout;
                    calendarContainer.addEventListener('wheel', (e) => {
                        if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) {
                            e.preventDefault();
                            clearTimeout(scrollTimeout);
                            scrollTimeout = setTimeout(() => {
                                if (e.deltaX > 20 && currentMonthIndex < 11) {
                                    window.calendarDirection = 'right';
                                    currentMonthIndex++;
                                    generateBudgetCalendar(isPWDMode);
                                } else if (e.deltaX < -20 && currentMonthIndex > 0) {
                                    window.calendarDirection = 'left';
                                    currentMonthIndex--;
                                    generateBudgetCalendar(isPWDMode);
                                }
                            }, 100);
                        }
                    }, { passive: false });
                }

                scrollListenersInitialized = true;
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            document.getElementById('themeIcon').textContent = isDark ? '🌙' : '☀️';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        // Scroll-based header expansion
        document.addEventListener('DOMContentLoaded', () => {
            const siteHeader = document.querySelector('.site-header');
            const brandBadge = document.querySelector('.brand-badge');
            let ticking = false;

            function updateHeaderSpacing() {
                const scrollY = window.scrollY;
                const maxScroll = 400; // Max scroll distance for full effect
                const scrollProgress = Math.min(scrollY / maxScroll, 1);

                // Mobile-first: adjust based on screen size
                const isMobile = window.innerWidth <= 768;
                const startPadding = isMobile ? 12 : 20;
                const minPadding = isMobile ? 8 : 8;

                // DECREASE side padding to push to corners
                const sidePadding = startPadding - (scrollProgress * (startPadding - minPadding));

                // Shrink brand badge as we scroll (less aggressive on mobile)
                const scaleAmount = isMobile ? 0.2 : 0.3;
                const opacityAmount = isMobile ? 0.3 : 0.5;
                const badgeScale = 1 - (scrollProgress * scaleAmount);
                const badgeOpacity = 1 - (scrollProgress * opacityAmount);

                if (siteHeader) {
                    siteHeader.style.paddingLeft = `${sidePadding}px`;
                    siteHeader.style.paddingRight = `${sidePadding}px`;
                }

                if (brandBadge) {
                    brandBadge.style.transform = `scale(${badgeScale})`;
                    brandBadge.style.opacity = badgeOpacity;
                }

                ticking = false;
            }

            window.addEventListener('scroll', () => {
                if (!ticking) {
                    window.requestAnimationFrame(updateHeaderSpacing);
                    ticking = true;
                }
            });

            // Initialize on load
            updateHeaderSpacing();

            // Pull to refresh (mobile)
            const pullIndicator = document.getElementById('pullIndicator');
            let touchStartY = 0;
            let isPulling = false;
            const PULL_THRESHOLD = 80;

            document.addEventListener('touchstart', (e) => {
                if (window.scrollY === 0) {
                    touchStartY = e.touches[0].clientY;
                    isPulling = true;
                }
            }, { passive: true });

            document.addEventListener('touchmove', (e) => {
                if (!isPulling || window.scrollY > 0) return;
                const touchY = e.touches[0].clientY;
                const pullDistance = touchY - touchStartY;

                if (pullDistance > 0 && pullDistance < PULL_THRESHOLD * 2) {
                    if (pullIndicator) {
                        pullIndicator.classList.add('visible');
                        pullIndicator.style.transform = `translateX(-50%) translateY(${Math.min(pullDistance * 0.5, 40)}px)`;
                    }
                    if (pullDistance > PULL_THRESHOLD * 0.5) {
                        haptic('light');
                    }
                }
            }, { passive: true });

            document.addEventListener('touchend', () => {
                if (!isPulling) return;
                isPulling = false;

                if (pullIndicator && pullIndicator.classList.contains('visible')) {
                    const transform = pullIndicator.style.transform;
                    const match = transform.match(/translateY\((\d+)px\)/);
                    const currentY = match ? parseInt(match[1]) : 0;

                    if (currentY >= 35) {
                        haptic('medium');
                        pullIndicator.classList.add('refreshing');
                        setTimeout(() => location.reload(), 500);
                    } else {
                        pullIndicator.classList.remove('visible');
                        pullIndicator.style.transform = '';
                    }
                }
            }, { passive: true });
        });

        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize theme
            const theme = localStorage.getItem('theme');
            if (theme === 'dark' || (!theme && matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.classList.add('dark');
                document.getElementById('themeIcon').textContent = '🌙';
            }

            matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (!theme) {
                    document.body.classList.toggle('dark', e.matches);
                    document.getElementById('themeIcon').textContent = e.matches ? '🌙' : '☀️';
                }
            });

            // Load holdings data
            try {
                holdingsData = await loadHoldings();
            } catch (error) {
                console.error('Failed to load holdings:', error);
                holdingsData = buildHoldings();
            }
            if (!holdingsData || holdingsData.length === 0) {
                holdingsData = buildHoldings();
            }
            const table = document.getElementById('stockTable');
            const headers = table ? table.querySelectorAll('th') : [];
            const tbody = table ? table.querySelector('tbody') : null;
            const totalsRow = table ? table.querySelector('tfoot tr') : null;
            const pieHoldings = [...holdingsData].sort((a, b) => b.currentValue - a.currentValue);
            const tableHoldings = [...holdingsData].sort((a, b) => b.gainPercent - a.gainPercent);

            const currentTotal = holdingsData.reduce((sum, holding) => sum + holding.currentValue, 0);
            const targetTotal = holdingsData.reduce((sum, holding) => sum + holding.targetValue, 0);

            const financialSnapshot = updateFinancialSections(currentTotal, targetTotal);
            updateMarketInsights(financialSnapshot);
            generateBudgetCalendar(isPWDMode);

            // PWD toggle
            const pwdToggle = document.getElementById('pwdToggle');
            if (pwdToggle) {
                pwdToggle.addEventListener('change', () => {
                    isPWDMode = pwdToggle.checked;
                    document.getElementById('incomeValue').textContent = isPWDMode ? '$1,558' : '$1,113';
                    generateBudgetCalendar(isPWDMode);
                });
            }

            if (totalsRow) {
                const currentCell = totalsRow.querySelector('td:nth-child(5)');
                const targetCell = totalsRow.querySelector('td:nth-child(7)');
                const gainCell = totalsRow.querySelector('td:nth-child(8)');
                if (currentCell) currentCell.innerHTML = `<strong>${formatCurrency(currentTotal)}</strong>`;
                if (targetCell) targetCell.innerHTML = `<strong>${formatCurrency(targetTotal)}</strong>`;
                if (gainCell) {
                    const totalGainPercent = currentTotal > 0 ? Math.round(((targetTotal - currentTotal) / currentTotal) * 100) : 0;
                    const gainSign = totalGainPercent >= 0 ? '+' : '';
                    gainCell.innerHTML = `<strong>${gainSign}${totalGainPercent}%</strong>`;
                }
            }

            const pieChart = document.getElementById('stockPieChart');
            const pieCanvas = document.getElementById('stockPieCanvas');
            let pieCtx = pieCanvas ? pieCanvas.getContext('2d') : null;
            let pieRenderFrame = null;
            const pieCenter = document.getElementById('stockPieCenter');
            const pieLegend = document.getElementById('stockPieLegend');
            const pieLogos = document.getElementById('stockPieLogos');
            const PIE_ACTIVE_SCALE = 1.015;
            const PIE_RADIUS = 120;
            const PIE_CENTER_COORD = 130;

            let pieLogicalSize = 0;
            const resizePieCanvas = () => {
                if (!pieCanvas) return false;
                const rect = pieChart.getBoundingClientRect();
                const size = Math.min(rect.width, rect.height);
                if (size <= 0) return false;
                pieLogicalSize = size;
                const scale = window.devicePixelRatio || 1;
                pieCanvas.style.width = `${size}px`;
                pieCanvas.style.height = `${size}px`;
                pieCanvas.width = size * scale;
                pieCanvas.height = size * scale;
                if (!pieCtx) {
                    pieCtx = pieCanvas.getContext('2d');
                }
                // Reset transform before scaling to prevent compounding
                pieCtx.setTransform(1, 0, 0, 1, 0, 0);
                pieCtx.scale(scale, scale);
                return true;
            };
            if (pieCanvas) {
                resizePieCanvas();
                window.addEventListener('resize', resizePieCanvas);
            }
            const legendMap = {};
            const logoMap = {};
            const tableRowMap = {};
            const sliceGeometry = {};
            let activeSymbol = null;

            const schedulePieRender = (retryCount = 0) => {
                if (pieRenderFrame) cancelAnimationFrame(pieRenderFrame);
                pieRenderFrame = requestAnimationFrame(() => {
                    const resized = resizePieCanvas();
                    if (!resized && retryCount < 10) {
                        setTimeout(() => schedulePieRender(retryCount + 1), 50);
                        return;
                    }
                    renderPie(activeSymbol);
                });
            };

            const renderPie = (activeSymbol = null) => {
                if (!pieCtx || !pieCanvas || pieLogicalSize <= 0) {
                    console.warn('Canvas not ready for pie chart');
                    return;
                }
                const size = pieLogicalSize;
                const centerCoord = size / 2;
                const radius = (size * 0.92) / 2;

                // Mobile/dark mode detection (once per render, not per slice)
                const isMobile = size < 300;
                const minSlicePercent = isMobile ? 8 : 5;
                const isDark = document.body.classList.contains('dark');

                pieCtx.save();
                pieCtx.clearRect(0, 0, size, size);

                pieHoldings.forEach(item => {
                    const geometry = sliceGeometry[item.symbol];
                    if (!geometry) return;
                    const startAngle = (geometry.startDeg - 90) * (Math.PI / 180);
                    const sweepAngle = geometry.sweepDeg * (Math.PI / 180);
                    const endAngle = startAngle + sweepAngle;
                    const isActive = activeSymbol === item.symbol;
                    // Smaller slices get larger offset when active for better visibility
                    const slicePercent = geometry.sweepDeg / 360 * 100;
                    const baseOffset = slicePercent < 15 ? 24 : 6; // 4x offset for small slices
                    const offset = isActive ? baseOffset : 0;
                    const midAngle = startAngle + sweepAngle / 2;
                    const dx = Math.cos(midAngle) * offset;
                    const dy = Math.sin(midAngle) * offset;

                    pieCtx.save();
                    pieCtx.beginPath();
                    pieCtx.moveTo(centerCoord + dx, centerCoord + dy);
                    // Increase radius expansion for small slices
                    const radiusExpansion = isActive ? (slicePercent < 15 ? 10 : 2) : 0;
                    pieCtx.arc(centerCoord + dx, centerCoord + dy, radius + radiusExpansion, startAngle, endAngle);
                    pieCtx.closePath();
                    pieCtx.fillStyle = item.color;
                    pieCtx.shadowColor = 'rgba(0,0,0,0.08)';
                    pieCtx.shadowBlur = isActive ? (slicePercent < 15 ? 35 : 20) : 8;
                    pieCtx.fill();

                    // Draw percentage label on slice (mobile-first, dark mode support)
                    if (slicePercent >= minSlicePercent) {
                        const labelRadius = radius * 0.7; // 70% from center
                        const labelX = centerCoord + dx + Math.cos(midAngle) * labelRadius;
                        const labelY = centerCoord + dy + Math.sin(midAngle) * labelRadius;

                        // Responsive font: 11-16px scaled by canvas size
                        const fontSize = Math.max(11, Math.min(16, size * 0.055));
                        pieCtx.shadowBlur = 0;
                        pieCtx.font = `bold ${fontSize}px -apple-system, BlinkMacSystemFont, sans-serif`;
                        pieCtx.textAlign = 'center';
                        pieCtx.textBaseline = 'middle';

                        // Stroke for contrast (thinner on mobile for cleaner look)
                        pieCtx.strokeStyle = isDark ? 'rgba(0, 0, 0, 0.5)' : 'rgba(0, 0, 0, 0.3)';
                        pieCtx.lineWidth = isMobile ? 2 : 2.5;
                        pieCtx.strokeText(`${slicePercent.toFixed(1)}%`, labelX, labelY);

                        // Fill color adapts to theme
                        pieCtx.fillStyle = isDark ? 'rgba(255, 255, 255, 0.95)' : 'rgba(255, 255, 255, 0.98)';
                        pieCtx.fillText(`${slicePercent.toFixed(1)}%`, labelX, labelY);
                    }

                    pieCtx.restore();
                });

                pieCtx.restore();
            };

            const clearSliceHighlight = () => {
                renderPie();
                if (pieLogos) {
                    pieLogos.style.transform = 'translate(0px, 0px) scale(1)';
                }
            };

            const highlightSlice = (item) => {
                if (!pieChart) return;
                const geometry = sliceGeometry[item.symbol];
                if (!geometry) return;
                const { midAngle } = geometry;
                const radians = (midAngle - 90) * (Math.PI / 180);
                const shiftX = Math.cos(radians) * 10;
                const shiftY = Math.sin(radians) * 10;
                if (pieLogos) {
                    pieLogos.style.transform = `translate(${shiftX}px, ${shiftY}px) scale(${PIE_ACTIVE_SCALE})`;
                }
                renderPie(item.symbol);
            };

            const defaultCenter = () => {
                if (pieCenter) {
                    pieCenter.innerHTML = `${formatCurrency(currentTotal)}<span>Current</span>`;
                }
                clearSliceHighlight();
                Object.values(legendMap).forEach(li => li.classList.remove('active'));
                Object.values(logoMap).forEach(logo => logo.classList.remove('active'));
                Object.values(tableRowMap).forEach(row => row.classList.remove('active'));
            };

            const activateSlice = (symbol) => {
                const item = holdingsData.find(entry => entry.symbol === symbol);
                if (!item || !pieCenter) return;
                if (activeSymbol !== symbol) haptic('light');
                activeSymbol = symbol;
                pieCenter.innerHTML = `${formatCurrency(item.currentValue, item.currency)}<span>${item.symbol} • ${formatPercent(item.gainPercent)} target</span>`;
                Object.entries(legendMap).forEach(([sym, li]) => {
                    li.classList.toggle('active', sym === symbol);
                });
                Object.entries(logoMap).forEach(([sym, logo]) => {
                    logo.classList.toggle('active', sym === symbol);
                });
                Object.entries(tableRowMap).forEach(([sym, row]) => {
                    row.classList.toggle('active', sym === symbol);
                });
                highlightSlice(item);
            };

            const resetSlice = () => {
                activeSymbol = null;
                defaultCenter();
            };
            const toggleSlice = (symbol) => {
                if (activeSymbol === symbol) {
                    resetSlice();
                } else {
                    activateSlice(symbol);
                }
            };
            if (pieChart && pieCenter && pieLegend) {
                let startPercent = 0;
                pieHoldings.forEach(item => {
                    const share = currentTotal > 0 ? item.currentValue / currentTotal : 0;
                    const sweepPercent = share * 100;
                    const startDeg = startPercent * 3.6;
                    const sweepDeg = sweepPercent * 3.6;
                    sliceGeometry[item.symbol] = {
                        startDeg,
                        sweepDeg,
                        midAngle: startDeg + sweepDeg / 2,
                        color: item.color
                    };
                    startPercent += sweepPercent;
                });
                schedulePieRender();
                // Backup render after full page load to fix race conditions
                window.addEventListener('load', () => {
                    schedulePieRender();
                    // Additional delayed render to ensure colors are fully loaded
                    setTimeout(() => schedulePieRender(), 100);
                });
                pieChart.style.cursor = 'pointer';

                pieChart.addEventListener('mousemove', (event) => {
                    if (!sliceGeometry || !Object.keys(sliceGeometry).length) return;
                    const rect = pieChart.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    const deltaX = event.clientX - centerX;
                    const deltaY = event.clientY - centerY;
                    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                    const size = Math.min(rect.width, rect.height);
                    const radius = (size * 0.92) / 2;
                    if (distance > radius || distance < radius * 0.25) {
                        if (!activeSymbol) {
                            clearSliceHighlight();
                        }
                        return;
                    }
                    let angle = Math.atan2(deltaY, deltaX) * (180 / Math.PI);
                    angle = angle < -90 ? 450 + angle : angle + 90;
                    const matched = pieHoldings.find(item => {
                        const geom = sliceGeometry[item.symbol];
                        if (!geom) return false;
                        const normalized = angle % 360;
                        const start = geom.startDeg % 360;
                        const end = (geom.startDeg + geom.sweepDeg) % 360;
                        if (geom.sweepDeg >= 360) return true;
                        if (start < end) {
                            return normalized >= start && normalized <= end;
                        }
                        return normalized >= start || normalized <= end;
                    });
                    if (matched) {
                        activateSlice(matched.symbol);
                    }
                });

                pieChart.addEventListener('mouseleave', () => {
                    if (!activeSymbol) {
                        clearSliceHighlight();
                    } else {
                        activateSlice(activeSymbol);
                    }
                });

                // Touch event support for mobile
                pieChart.addEventListener('touchmove', (event) => {
                    if (!sliceGeometry || !Object.keys(sliceGeometry).length) return;
                    event.preventDefault();
                    const touch = event.touches[0];
                    const rect = pieChart.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    const deltaX = touch.clientX - centerX;
                    const deltaY = touch.clientY - centerY;
                    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                    const size = Math.min(rect.width, rect.height);
                    const radius = (size * 0.92) / 2;
                    if (distance > radius || distance < radius * 0.25) {
                        if (!activeSymbol) {
                            clearSliceHighlight();
                        }
                        return;
                    }
                    let angle = Math.atan2(deltaY, deltaX) * (180 / Math.PI);
                    angle = angle < -90 ? 450 + angle : angle + 90;
                    const matched = pieHoldings.find(item => {
                        const geom = sliceGeometry[item.symbol];
                        if (!geom) return false;
                        const normalized = angle % 360;
                        const start = geom.startDeg % 360;
                        const end = (geom.startDeg + geom.sweepDeg) % 360;
                        if (geom.sweepDeg >= 360) return true;
                        if (start < end) {
                            return normalized >= start && normalized <= end;
                        }
                        return normalized >= start || normalized <= end;
                    });
                    if (matched) {
                        activateSlice(matched.symbol);
                    }
                }, { passive: false });

                pieChart.addEventListener('touchend', () => {
                    if (!activeSymbol) {
                        clearSliceHighlight();
                    } else {
                        activateSlice(activeSymbol);
                    }
                });
                pieChart.addEventListener('click', (event) => {
                    const rect = pieChart.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    const deltaX = event.clientX - centerX;
                    const deltaY = event.clientY - centerY;
                    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                    const size = Math.min(rect.width, rect.height);
                    const radius = (size * 0.92) / 2;
                    if (distance > radius || distance < radius * 0.25) return;
                    let angle = Math.atan2(deltaY, deltaX) * (180 / Math.PI);
                    angle = angle < -90 ? 450 + angle : angle + 90;
                    const matched = pieHoldings.find(item => {
                        const geom = sliceGeometry[item.symbol];
                        if (!geom) return false;
                        const normalized = angle % 360;
                        const start = geom.startDeg % 360;
                        const end = (geom.startDeg + geom.sweepDeg) % 360;
                        if (geom.sweepDeg >= 360) return true;
                        if (start < end) {
                            return normalized >= start && normalized <= end;
                        }
                        return normalized >= start || normalized <= end;
                    });
                    if (matched) {
                        toggleSlice(matched.symbol);
                    }
                });
                animateValueHTML(pieCenter, currentTotal, 1000, 'USD', '<span>Current</span>');

                pieLegend.innerHTML = '';
                if (pieLogos) {
                    pieLogos.innerHTML = '';
                }
                pieHoldings.forEach(item => {
                    const li = document.createElement('li');
                    const swatch = document.createElement('span');
                    swatch.className = 'legend-swatch';
                    swatch.style.background = item.color;

                    const label = document.createElement('span');
                    label.className = 'legend-label';
                    label.textContent = item.symbol;

                    const value = document.createElement('span');
                    value.className = 'legend-value';
                    value.textContent = formatCurrency(item.currentValue, item.currency);

                    li.appendChild(swatch);
                    li.appendChild(label);
                    li.appendChild(value);
                    li.style.background = 'transparent';
                    li.style.backgroundColor = 'transparent';
                    pieLegend.appendChild(li);
                    legendMap[item.symbol] = li;
                    li.tabIndex = 0;
                    li.setAttribute('role', 'button');
                    li.setAttribute('aria-label', `${item.symbol} ${formatCurrency(item.currentValue, item.currency)}, ${formatPercent(item.gainPercent)} potential`);
                    const enterLegend = () => activateSlice(item.symbol);
                    const leaveLegend = () => resetSlice();
                    li.addEventListener('mouseenter', enterLegend);
                    li.addEventListener('mouseleave', leaveLegend);
                    li.addEventListener('focus', enterLegend);
                    li.addEventListener('blur', leaveLegend);
                    const handleLegendToggle = () => toggleSlice(item.symbol);
                    li.addEventListener('click', handleLegendToggle);
                    li.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        handleLegendToggle();
                    });
                });

                if (pieLogos) {
                    pieHoldings.forEach(item => {
                        const geometry = sliceGeometry[item.symbol];
                        const midAngle = geometry ? geometry.midAngle : 0;
                        const radians = (midAngle - 90) * (Math.PI / 180);
                        const radius = 125; // stay within wrapper bounds
                        const x = 130 + Math.cos(radians) * radius;
                        const y = 130 + Math.sin(radians) * radius;
                        const logo = document.createElement('div');
                        logo.className = 'pie-logo';
                        logo.style.background = item.color;
                        logo.style.color = getContrastColor(item.color);
                        logo.style.left = `${x}px`;
                        logo.style.top = `${y}px`;
                        logo.dataset.symbol = item.symbol;
                        logo.tabIndex = 0;
                        logo.setAttribute('role', 'button');
                        logo.setAttribute('aria-label', `${item.symbol} ${formatCurrency(item.currentValue, item.currency)}, ${formatPercent(item.gainPercent)} potential`);
                        if (item.logoSvg) {
                            logo.innerHTML = item.logoSvg;
                        } else {
                            const span = document.createElement('span');
                            span.textContent = item.logoLabel || item.symbol[0];
                            logo.appendChild(span);
                        }
                        pieLogos.appendChild(logo);
                        logoMap[item.symbol] = logo;
                        const enterLogo = () => activateSlice(item.symbol);
                        const leaveLogo = () => resetSlice();
                        logo.addEventListener('mouseenter', enterLogo);
                        logo.addEventListener('mouseleave', leaveLogo);
                        logo.addEventListener('focus', enterLogo);
                        logo.addEventListener('blur', leaveLogo);
                        logo.addEventListener('click', (e) => {
                            e.preventDefault();
                            toggleSlice(item.symbol);
                        });
                    });
                }
                defaultCenter();
            }

            if (tbody) {
                tbody.innerHTML = '';
                tableHoldings.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.dataset.symbol = item.symbol;
                    tr.tabIndex = 0;

                    const symbolCell = document.createElement('td');
                    const link = document.createElement('a');
                    link.href = item.url || '#';
                    link.target = '_blank';
                    link.rel = 'noopener';
                    link.textContent = item.symbol;
                    symbolCell.appendChild(link);

                    if (item.earningsStatus) {
                        const badge = document.createElement('span');
                        badge.className = 'earnings-badge';
                        badge.dataset.status = item.earningsStatus;
                        badge.setAttribute('role', 'img');
                        badge.setAttribute('aria-label', item.earningsLabel || item.earningsStatus);
                        badge.title = item.earningsLabel || item.earningsStatus;
                        symbolCell.appendChild(badge);
                    }

                    const sharesCell = document.createElement('td');
                    sharesCell.textContent = formatShares(item.shares);

                    const priceCell = document.createElement('td');
                    priceCell.textContent = formatPrice(item.price, item.currency);

                    const dailyCell = document.createElement('td');
                    const dailyValue = Number.isFinite(item.dailyChangePercent) ? item.dailyChangePercent : 0;
                    const dailySign = dailyValue > 0 ? '+' : '';
                    dailyCell.textContent = `${dailySign}${dailyValue.toFixed(2)}%`;
                    dailyCell.style.color = dailyValue > 0 ? '#2ecc71' : dailyValue < 0 ? '#ff3b30' : 'inherit';
                    dailyCell.style.fontWeight = '600';

                    const currentCell = document.createElement('td');
                    currentCell.textContent = formatCurrency(item.currentValue, item.currency);

                    const targetPriceCell = document.createElement('td');
                    targetPriceCell.textContent = formatPrice(item.targetPrice);

                    const targetValueCell = document.createElement('td');
                    targetValueCell.textContent = formatCurrency(item.targetValue);

                    const gainCell = document.createElement('td');
                    gainCell.textContent = formatPercent(item.gainPercent);

                    tr.appendChild(symbolCell);
                    tr.appendChild(sharesCell);
                    tr.appendChild(priceCell);
                    tr.appendChild(dailyCell);
                    tr.appendChild(currentCell);
                    tr.appendChild(targetPriceCell);
                    tr.appendChild(targetValueCell);
                    tr.appendChild(gainCell);

                    tr.addEventListener('mouseenter', () => activateSlice(item.symbol));
                    tr.addEventListener('mouseleave', () => resetSlice());
                    tr.addEventListener('focusin', () => activateSlice(item.symbol));
                    tr.addEventListener('focusout', () => resetSlice());
                    tr.addEventListener('click', () => toggleSlice(item.symbol));
                    tr.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter' || event.key === ' ') {
                            event.preventDefault();
                            toggleSlice(item.symbol);
                        }
                    });

                    tbody.appendChild(tr);
                    tableRowMap[item.symbol] = tr;
                });

                defaultCenter();
            }

            const pieView = document.getElementById('stockPieView');
            const tableView = document.getElementById('stockTableWrapper');
            const viewToggleButtons = document.querySelectorAll('[data-view-toggle]');

            function setPortfolioView(view) {
                if (!pieView || !tableView) return;
                if (view === 'table') {
                    pieView.classList.add('hidden');
                    tableView.classList.remove('hidden');
                } else {
                    pieView.classList.remove('hidden');
                    tableView.classList.add('hidden');
                    schedulePieRender();
                }

                viewToggleButtons.forEach(btn => {
                    const isActive = btn.dataset.viewToggle === view;
                    btn.classList.toggle('active', isActive);
                    btn.setAttribute('aria-pressed', String(isActive));
                });

                resetSlice();
            }

            setPortfolioView('pie');
            defaultCenter();

            viewToggleButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const view = button.dataset.viewToggle;
                    setPortfolioView(view);
                });
            });

            if (pieCenter) {
                pieCenter.tabIndex = 0;
                pieCenter.addEventListener('click', () => resetSlice());
                pieCenter.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        resetSlice();
                    }
                });
            }

            initSlideToggle({
                toggle: document.getElementById('marketInsightsToggle'),
                content: document.getElementById('marketInsightsContent'),
                card: document.getElementById('marketInsightsCard'),
                defaultOpen: false
            });
            initSlideToggle({
                toggle: document.getElementById('budgetToggle'),
                content: document.getElementById('budgetContent'),
                card: document.getElementById('budgetCard'),
                defaultOpen: true
            });
            initSlideToggle({
                toggle: document.getElementById('debtToggle'),
                content: document.getElementById('debtContent'),
                card: document.getElementById('debtCard'),
                defaultOpen: false
            });
            initSlideToggle({
                toggle: document.getElementById('summaryToggle'),
                content: document.getElementById('summaryContent'),
                card: document.getElementById('summaryCard'),
                defaultOpen: false
            });

            headers.forEach((header, index) => {
                header.classList.add('sortable');
                header.dataset.column = index;
                header.dataset.order = 'desc';
            });

            function getCellValue(row, index) {
                const cell = row ? row.cells[index] : null;
                if (!cell) return '';
                const text = cell.textContent.trim();
                if (text.startsWith('$')) return parseFloat(text.replace(/[$,]/g, '')) || 0;
                if (text.includes('%')) return parseFloat(text.replace(/[+%]/g, '')) || 0;
                if (!isNaN(text) && text !== '') return parseFloat(text);
                return text.toLowerCase();
            }

            function sortTable(column, order) {
                if (!tbody) return;
                const rows = Array.from(tbody.querySelectorAll('tr'));
                rows.sort((a, b) => {
                    const aVal = getCellValue(a, column);
                    const bVal = getCellValue(b, column);
                    if (typeof aVal === 'number' && typeof bVal === 'number') {
                        return order === 'asc' ? aVal - bVal : bVal - aVal;
                    }
                    return order === 'asc' ? (aVal > bVal ? 1 : aVal < bVal ? -1 : 0) : (aVal < bVal ? 1 : aVal > bVal ? -1 : 0);
                });

                tbody.innerHTML = '';
                rows.forEach(row => tbody.appendChild(row));
            }

            headers.forEach(header => {
                header.addEventListener('click', () => {
                    const column = parseInt(header.dataset.column, 10);
                    const newOrder = header.dataset.order === 'asc' ? 'desc' : 'asc';

                    headers.forEach(h => {
                        h.classList.remove('sorted-asc', 'sorted-desc');
                        h.dataset.order = 'desc';
                    });

                    header.classList.add(newOrder === 'asc' ? 'sorted-asc' : 'sorted-desc');
                    header.dataset.order = newOrder;
                    sortTable(column, newOrder);
                });
            });

            const dailyHeader = headers[3];
            if (dailyHeader) {
                dailyHeader.classList.add('sorted-desc');
                dailyHeader.dataset.order = 'desc';
                sortTable(3, 'desc');
            }

            // Payday countdown
            const BUDGET_CONFIG = {
                vacationFund: 8  // CAD - update from screenshot
            };

            function updatePaydayCountdown() {
                const now = new Date();
                const paydays = [
                    new Date('2025-11-19T00:00:00'),
                    new Date('2025-12-17T00:00:00'),
                    new Date('2026-01-19T00:00:00')
                ];
                let nextPayday = null;
                for (const payday of paydays) {
                    if (payday > now) {
                        nextPayday = payday;
                        break;
                    }
                }
                if (!nextPayday) {
                    const el = document.getElementById('paydayCountdown');
                    const dateLabel = document.getElementById('paydayDateLabel');
                    const dailyEl = document.getElementById('dailyAllowance');
                    if (el) el.textContent = 'No upcoming payday';
                    if (dateLabel) dateLabel.textContent = '';
                    if (dailyEl) dailyEl.textContent = '--';
                    return;
                }
                const diff = Math.max(nextPayday - now, 0);
                const dayMs = 24 * 60 * 60 * 1000;
                const hourMs = 60 * 60 * 1000;
                const minuteMs = 60 * 1000;
                const secondMs = 1000;
                const days = Math.floor(diff / dayMs);
                const hours = Math.floor((diff % dayMs) / hourMs);
                const minutes = Math.floor((diff % hourMs) / minuteMs);
                const seconds = Math.floor((diff % minuteMs) / secondMs);
                const milliseconds = diff % 1000;
                const el = document.getElementById('paydayCountdown');
                if (el) {
                    el.textContent = `${days}d ${hours.toString().padStart(2, '0')}h ${minutes
                        .toString()
                        .padStart(2, '0')}m ${seconds.toString().padStart(2, '0')}s ${milliseconds
                        .toString()
                        .padStart(3, '0')}ms`;
                }
                const dateLabel = document.getElementById('paydayDateLabel');
                if (dateLabel) {
                    const formattedDate = nextPayday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const weekday = nextPayday.toLocaleDateString('en-US', { weekday: 'short' });
                    dateLabel.textContent = `${formattedDate} · ${weekday}`;
                }
                // Daily allowance = vacation fund / days remaining (including partial day)
                const daysRemaining = diff / dayMs;
                const dailyAllowance = daysRemaining > 0 ? BUDGET_CONFIG.vacationFund / daysRemaining : 0;
                const dailyEl = document.getElementById('dailyAllowance');
                if (dailyEl) {
                    dailyEl.textContent = `$${dailyAllowance.toFixed(2)}/day`;
                }
                const vacationEl = document.getElementById('vacationFund');
                if (vacationEl) {
                    vacationEl.textContent = `$${BUDGET_CONFIG.vacationFund.toFixed(2)}`;
                }
            }
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', updatePaydayCountdown);
            } else {
                updatePaydayCountdown();
            }
            setInterval(updatePaydayCountdown, 100);

            // Tab Navigation System
            const tabs = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            function switchTab(tabName) {
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
                const activeContent = document.querySelector(`[data-tab-content="${tabName}"]`);
                if (activeTab) activeTab.classList.add('active');
                if (activeContent) activeContent.classList.add('active');
                localStorage.setItem('activeTab', tabName);
            }
            tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            const savedTab = localStorage.getItem('activeTab') || 'portfolio';
            switchTab(savedTab);

            // Keyboard shortcuts for tabs
            document.addEventListener('keydown', (e) => {
                // Ignore if typing in input/textarea or if modifier keys are pressed
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.ctrlKey || e.metaKey || e.altKey) {
                    return;
                }

                const key = e.key.toLowerCase();
                let tabName = null;

                switch(key) {
                    case 'p':
                        tabName = 'portfolio';
                        break;
                    case 'b':
                        tabName = 'budget';
                        break;
                    case 'd':
                        tabName = 'debt';
                        break;
                    case 's':
                        tabName = 'summary';
                        break;
                    case 'i':
                        tabName = 'insights';
                        break;
                }

                if (tabName) {
                    e.preventDefault();
                    switchTab(tabName);
                }
            });
        });

    </script>

    <!-- Pull to refresh indicator -->
    <div class="pull-indicator" id="pullIndicator">
        <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
    </div>

    <div class="container">
        <div class="site-header">
            <div style="display: flex; align-items: center; gap: 12px;">
                <a href="https://heyitsmejosh.com" class="back-button">←</a>
                <div class="brand-badge">
                    <div>
                        <div class="brand-name">Finn</div>
                        <div class="brand-tagline">Portfolio Companion</div>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle dark mode">
                    <span id="themeIcon">☀️</span>
                </button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="portfolio">Portfolio</button>
            <button class="tab-btn" data-tab="budget">Budget</button>
            <button class="tab-btn" data-tab="debt">Debt</button>
            <button class="tab-btn" data-tab="summary">Summary</button>
            <button class="tab-btn" data-tab="insights">Insights</button>
        </div>

        <div class="glass-card tab-content active" id="portfolioCard" data-tab-content="portfolio">
            <div class="portfolio-header">
                <h2>Portfolio</h2>
                <div class="view-toggle" role="group" aria-label="Toggle portfolio view">
                    <button type="button" class="active" data-view-toggle="pie">Pie</button>
                    <button type="button" data-view-toggle="table">Table</button>
                </div>
            </div>
            <div class="portfolio-views" data-current-view="pie">
                <div class="portfolio-pie-view" id="stockPieView">
                    <div class="pie-chart-wrapper">
                        <div class="pie-chart" id="stockPieChart">
                            <canvas id="stockPieCanvas" width="260" height="260"></canvas>
                            <div class="pie-center-label" id="stockPieCenter"></div>
                        </div>
                        <div class="pie-logo-ring" id="stockPieLogos"></div>
                    </div>
                    <ul class="chart-legend" id="stockPieLegend"></ul>
                </div>
                <div class="portfolio-table-view hidden" id="stockTableWrapper">
                    <table id="stockTable">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Shares</th>
                                <th>Current Price</th>
                                <th>Daily %</th>
                                <th>Current Value</th>
                                <th>Target Price</th>
                                <th>Target Value</th>
                                <th>Gain</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><a href="https://finance.yahoo.com/quote/PLTR" target="_blank">PLTR</a></td>
                                <td>0.0171</td>
                                <td>$167.33</td>
                                <td>$3</td>
                                <td>$450</td>
                                <td>$8</td>
                                <td>+156%</td>
                            </tr>
                            <tr>
                                <td><a href="https://finance.yahoo.com/quote/HOOD" target="_blank">HOOD</a></td>
                                <td>0.0934</td>
                                <td>$109.35</td>
                                <td>$12</td>
                                <td>$300</td>
                                <td>$28</td>
                                <td>+175%</td>
                            </tr>
                            <tr>
                                <td><a href="https://finance.yahoo.com/quote/IWM" target="_blank">IWM</a></td>
                                <td>0.0208</td>
                                <td>$238.74</td>
                                <td>$5</td>
                                <td>$320</td>
                                <td>$7</td>
                                <td>+34%</td>
                            </tr>
                            <tr>
                                <td><a href="https://finance.yahoo.com/quote/NVDA" target="_blank">NVDA</a></td>
                                <td>0.2702</td>
                                <td>$185.06</td>
                                <td>$50</td>
                                <td>$500</td>
                                <td>$135</td>
                                <td>+170%</td>
                            </tr>
                            <tr>
                                <td><a href="https://finance.yahoo.com/quote/TSLA" target="_blank">TSLA</a></td>
                                <td>0.1422</td>
                                <td>$410.50</td>
                                <td>$62</td>
                                <td>$800</td>
                                <td>$114</td>
                                <td>+95%</td>
                            </tr>
                            <tr>
                                <td><a href="https://finance.yahoo.com/quote/AAPL" target="_blank">AAPL</a></td>
                                <td>0.6538</td>
                                <td>$267.44</td>
                                <td>$176</td>
                                <td>$500</td>
                                <td>$327</td>
                                <td>+186%</td>
                            </tr>
                            <tr>
                                <td><a href="https://finance.yahoo.com/quote/SPY" target="_blank">SPY</a></td>
                                <td>0.3378</td>
                                <td>$660.55</td>
                                <td>$227</td>
                                <td>$1,100</td>
                                <td>$372</td>
                                <td>+66%</td>
                            </tr>
                            <tr>
                                <td><a href="https://finance.yahoo.com/quote/SBUX" target="_blank">SBUX</a></td>
                                <td>0.1432</td>
                                <td>$82.24</td>
                                <td>$12</td>
                                <td>$130</td>
                                <td>$19</td>
                                <td>+58%</td>
                            </tr>
                            <tr>
                                <td><a href="https://finance.yahoo.com/quote/V" target="_blank">V</a></td>
                                <td>0.2570</td>
                                <td>$336.64</td>
                                <td>$86</td>
                                <td>$550</td>
                                <td>$141</td>
                                <td>+64%</td>
                            </tr>
                            <tr>
                                <td><a href="https://www.coinbase.com/price/bitcoin" target="_blank">BTC-USD</a></td>
                                <td>0.0001927</td>
                                <td>$101,631</td>
                                <td>$20</td>
                                <td>$250,000</td>
                                <td>$48</td>
                                <td>+140%</td>
                            </tr>
                            <tr>
                                <td>CASH</td>
                                <td>—</td>
                                <td>—</td>
                                <td>$107</td>
                                <td>$107</td>
                                <td>$107</td>
                                <td>0%</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td><strong>Total</strong></td>
                                <td></td>
                                <td></td>
                                <td>—</td>
                                <td><strong>$787</strong></td>
                                <td></td>
                                <td><strong>$1,371</strong></td>
                                <td><strong>+74%</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <div class="glass-card tab-content market-insights-card" id="marketInsightsCard" data-tab-content="insights" style="justify-content: flex-start;">
            <h2 style="margin-bottom: 20px;">Insights</h2>
                <div class="market-insights-meta">
                    <div id="marketInsightsTimestamp">Pre-market outlook loading…</div>
                    <div class="market-clock-grid" id="marketClockGrid">
                        <div class="market-clock" id="pstClock">PST — --:--</div>
                        <div class="market-clock" id="estClock">EST — --:--</div>
                    </div>
                </div>
                <div class="market-pulse" id="marketPulseList">
                    <div class="market-pulse-item">
                        LOADING
                        <span>Fetching live quotes for a fresh read...</span>
                    </div>
                </div>
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(128, 128, 128, 0.2);">
                    <div style="font-size: 11px; font-weight: 700; color: #888; margin-bottom: 8px; letter-spacing: 0.5px;">MARKET NEWS · DEC 6, 2025</div>
                    <div style="font-size: 13px; line-height: 1.6; color: var(--text-secondary);">
                        <p style="margin: 0 0 10px 0;"><strong>CLOSED:</strong> Markets closed today (Saturday). Last session Dec 5.</p>
                        <p style="margin: 0 0 10px 0;"><strong>LAST SESSION:</strong> Portfolio -0.26%, GOOGL +0.79% led while HOOD dropped -3.79%</p>
                        <p style="margin: 0 0 10px 0;"><strong>TARGETS:</strong> SPY 60% upside · GOOGL 25% · Cash depleted</p>
                        <p style="margin: 0 0 10px 0;"><strong>NVDA:</strong> $182.36 (-0.56%). Slight dip after strong year.</p>
                        <p style="margin: 0 0 10px 0;"><strong>GOOGL:</strong> $320.13 (+0.79%). Led Friday's session.</p>
                        <p style="margin: 0 0 0 0;"><strong>HOOD:</strong> $131.89 (-3.79%). Sharp Friday decline.</p>
                    </div>
                </div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(128, 128, 128, 0.2);">
                    <div style="font-size: 11px; font-weight: 700; color: #888; margin-bottom: 12px; letter-spacing: 0.5px;">BLOOMBERG TELEVISION LIVE</div>
                    <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px;">
                        <iframe
                            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                            src="https://www.youtube.com/embed/iEpJwprxDdk"
                            title="Bloomberg Television Live"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen>
                        </iframe>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass-card tab-content" id="budgetCard" data-tab-content="budget">
            <h2 style="margin-bottom: 20px;">Budget</h2>
                <div class="payday-highlight">
                    <div class="payday-title">Next Payday</div>
                    <div id="paydayCountdown" class="payday-amount">Loading...</div>
                    <div id="paydayDateLabel" class="payday-date"></div>
                    <div class="payday-note">$1,113 monthly / ~$476 to invest</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Vacation Fund 🏝️ (CAD)</td>
                            <td class="dynamic-value" id="vacationFund">$38.75</td>
                        </tr>
                        <tr style="background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(5, 150, 105, 0.1));">
                            <td>Christmas Gifts 🎄 (CAD)<br><span style="font-size: 0.85em; color: #888; font-weight: 400;">4 family ($20-30) + 3 grandparents ($10)</span></td>
                            <td class="dynamic-value" id="christmasFund">$100.00<br><span style="font-size: 0.85em; color: #888;">~$110-150 needed</span></td>
                        </tr>
                        <tr>
                            <td>Apple AirPods  (CAD)<br><span style="font-size: 0.85em; color: #888; font-weight: 400;">Financeable: $20/month</span></td>
                            <td class="dynamic-value" id="airpodsFund">$0.00<br><span style="font-size: 0.85em; color: #888;">~$330 w/ tax</span></td>
                        </tr>
                        <tr>
                            <td>Daily Allowance</td>
                            <td class="dynamic-value" id="dailyAllowance">--</td>
                        </tr>
                        <tr>
                            <td>
                                Income
                                <label style="margin-left: 12px; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; font-size: 11px; color: #888;">
                                    <input type="checkbox" id="pwdToggle" style="cursor: pointer; width: 14px; height: 14px;">
                                    <span style="font-weight: 600; color: #00C805;">PWD +40%</span>
                                </label>
                            </td>
                            <td id="incomeValue">$1,113</td>
                        </tr>
                        <tr>
                            <td>Food</td>
                            <td>-$300</td>
                        </tr>
                        <tr>
                            <td>Phone + Apple Watch<br><span style="font-size: 0.85em; color: #888; font-weight: 400;">$380 Dec ($330 + $50 watch), then $180/mo</span></td>
                            <td>-$380</td>
                        </tr>
                        <tr>
                            <td>Old phone (1 payment left)<br><span style="font-size: 0.85em; color: #888; font-weight: 400;">$177 Dec bill + $500 device payoff</span></td>
                            <td>-$677</td>
                        </tr>
                        <tr>
                            <td>Gym</td>
                            <td>-$30</td>
                        </tr>
                        <tr class="future-expense">
                            <td>Apple Watch Ultra 3 (49mm)</td>
                            <td>-$50</td>
                        </tr>
                        <tr class="future-expense">
                            <td>Keyboard Mat + Keyboard</td>
                            <td>-$120</td>
                        </tr>
                        <tr class="future-expense">
                            <td>Final iPhone Bill</td>
                            <td>-$617</td>
                        </tr>
                        <tr class="future-expense">
                            <td>Door Lock</td>
                            <td>-$85</td>
                        </tr>
                        <tr class="future-expense">
                            <td>RBC Credit Card</td>
                            <td>-$5,500</td>
                        </tr>
                        <tr class="future-expense">
                            <td>Drain Snake Chemical</td>
                            <td>-$15</td>
                        </tr>
                        <tr class="future-expense">
                            <td>GBA Pokémon</td>
                            <td>-$320</td>
                        </tr>
                        <tr class="future-expense">
                            <td>Gold Chain</td>
                            <td>-$2,500</td>
                        </tr>
                        <tr class="future-expense">
                            <td>Dog</td>
                            <td>-$5,000</td>
                        </tr>
                    </tbody>
                </table>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 24px; margin-bottom: 12px;">
                    <h3 style="font-size: 14px; color: rgba(255,255,255,0.7); margin: 0;">Calendar</h3>
                    <div style="display: flex; gap: 8px;">
                        <button id="scrollStart" style="padding: 6px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: var(--text-primary); cursor: pointer; font-size: 12px;">← Previous</button>
                        <button id="scrollEnd" style="padding: 6px 12px; background: rgba(0, 200, 5, 0.2); border: 1px solid rgba(0, 200, 5, 0.4); border-radius: 6px; color: #00C805; cursor: pointer; font-size: 12px; font-weight: 600;">Next →</button>
                    </div>
                </div>
                <div style="font-size: 12px; color: #888; margin-bottom: 16px;">
                    <span id="timelineDescription">Current income: $476/month surplus</span>
                </div>
                <div id="budgetCalendar" style="overflow-x: auto; -webkit-overflow-scrolling: touch; padding: 12px 0; width: 100%; scroll-behavior: smooth;">
                    <div id="calendarMonths" style="display: grid; grid-auto-flow: column; grid-auto-columns: minmax(320px, 1fr); gap: 24px; padding-bottom: 16px;">
                        <!-- Interactive calendar months will be generated by JavaScript -->
                    </div>
                </div>
                <div id="calendarLegend" style="margin-top: 16px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 11px;">
                    <!-- Legend will be generated by JavaScript -->
                </div>
        </div>

        <div class="glass-card tab-content" id="debtCard" data-tab-content="debt" style="justify-content: space-between;">
            <div>
                <h2 style="margin-bottom: 20px;">Debt</h2>
                <div class="progress-summary">
                    <div class="progress-labels">
                        <span>$0</span>
                        <span>$931 saved (19%)</span>
                        <span>$4,700</span>
                    </div>
                    <div class="progress-bar-track">
                        <div class="progress-bar-fill"></div>
                    </div>
                </div>
                <table>
                    <tbody>
                        <tr>
                            <td>Total Assets (Portfolio + Savings)</td>
                            <td id="totalAssetsCell">$787 USD + $200 CAD (~$144 USD) = ~$931 USD</td>
                        </tr>
                        <tr>
                            <td>Debt Payoff Goal</td>
                            <td>$4,700</td>
                        </tr>
                        <tr>
                            <td>Remaining to Goal</td>
                            <td id="remainingToGoalCell">$4,069</td>
                        </tr>
                        <tr class="hidden-row">
                            <td>Current Debt</td>
                            <td>$4,000</td>
                        </tr>
                        <tr>
                            <td>Monthly Payment Capacity</td>
                            <td>$476</td>
                        </tr>
                        <tr>
                            <td>Months Until Debt-Free</td>
                            <td id="monthsToDebtFreeCell">8.4 months</td>
                        </tr>
                        <tr>
                            <td>Debt-Free Date</td>
                            <td id="debtFreeDateCell">July 2026</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 16px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 12px; color: #888;">
                See Budget Timeline for future purchases (MacBook, Apple Watch, etc.)
            </div>
        </div>

        <div class="glass-card tab-content" id="summaryCard" data-tab-content="summary" style="justify-content: flex-start;">
            <h2 style="margin-bottom: 20px;">Summary</h2>
                <table>
                    <tbody>
                        <tr>
                            <td><strong>Total Portfolio Value</strong></td>
                            <td id="summaryTotalPortfolio" class="skeleton">$0</td>
                        </tr>
                        <tr>
                            <td><strong>2030 Target</strong></td>
                            <td id="summaryTargetPortfolio" class="skeleton">$0</td>
                        </tr>
                        <tr>
                            <td><strong>Potential Gain</strong></td>
                            <td id="summaryPotentialGain">+$584 (+74%)</td>
                        </tr>
                        <tr>
                            <td><strong>Net Worth</strong></td>
                            <td id="summaryNetWorth">$931 - $4,700 = -$4,069</td>
                        </tr>
                        <tr>
                            <td><strong>Monthly Surplus (Nov)</strong></td>
                            <td>$1,113 - $637 = $476</td>
                        </tr>
                        <tr class="future-expense">
                            <td><strong>Monthly Surplus (Dec+)</strong></td>
                            <td>$1,113 - $460 = $653</td>
                        </tr>
                    </tbody>
                </table>

                <h3 style="margin-top: 24px; margin-bottom: 12px; font-size: 14px; color: rgba(255,255,255,0.7);">Portfolio Milestones</h3>
                <table>
                    <tbody id="milestonesTable">
                        <tr>
                            <td colspan="2" class="skeleton">Calculating milestones...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <footer class="site-footer">
        <a href="https://github.com/nulljosh/finn" target="_blank" rel="noopener">Built with <span class="heart">&hearts;</span> in Vancouver, BC</a>
        <div style="margin-top: 8px;">&copy; 2025-2026</div>
    </footer>
</body>
</html>
