<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Spreadsheet</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #f5f5f7;
            --bg-secondary: #fafafa;
            --bg-card: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --border-color: rgba(0,0,0,0.06);
            --shadow-sm: 0 2px 16px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 24px rgba(0,0,0,0.08);
            --header-bg: rgba(255, 255, 255, 0.8);
            --input-bg: #f5f5f7;
            --input-hover: #ebebed;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #000000;
                --bg-secondary: #1c1c1e;
                --bg-card: #1c1c1e;
                --text-primary: #f5f5f7;
                --text-secondary: #98989d;
                --border-color: rgba(255,255,255,0.1);
                --shadow-sm: 0 2px 16px rgba(0,0,0,0.3);
                --shadow-md: 0 4px 24px rgba(0,0,0,0.5);
                --header-bg: rgba(28, 28, 30, 0.8);
                --input-bg: #2c2c2e;
                --input-hover: #3a3a3c;
            }
        }

        body.light-mode {
            --bg-primary: #f5f5f7;
            --bg-secondary: #fafafa;
            --bg-card: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --border-color: rgba(0,0,0,0.06);
            --shadow-sm: 0 2px 16px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 24px rgba(0,0,0,0.08);
            --header-bg: rgba(255, 255, 255, 0.8);
            --input-bg: #f5f5f7;
            --input-hover: #ebebed;
        }

        body.dark-mode {
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e;
            --bg-card: #1c1c1e;
            --text-primary: #f5f5f7;
            --text-secondary: #98989d;
            --border-color: rgba(255,255,255,0.1);
            --shadow-sm: 0 2px 16px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 24px rgba(0,0,0,0.5);
            --header-bg: rgba(28, 28, 30, 0.8);
            --input-bg: #2c2c2e;
            --input-hover: #3a3a3c;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg-primary); overflow-x: hidden; transition: background 0.3s ease; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        html { overflow-x: hidden; scroll-behavior: smooth; }
        .header { background: var(--header-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-color); padding: 12px 24px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease; contain: layout style; }
        .header h1 { font-size: 20px; font-weight: 600; color: var(--text-primary); letter-spacing: -0.5px; }
        .container { max-width: 1280px; margin: 0 auto; padding: 24px; contain: layout; }
        .card { background: var(--bg-card); border-radius: 16px; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); overflow: hidden; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); will-change: transform, box-shadow; contain: layout style paint; }
        .card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px) translateZ(0); }

        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 300px; }
        thead { background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); }
        th { padding: 12px 24px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        th:last-child { text-align: right; }
        tbody tr { border-bottom: 1px solid var(--border-color); transition: background 0.2s ease; }
        tbody tr:hover { background: var(--bg-secondary); }
        td { padding: 16px 24px; color: var(--text-primary); }
        td:last-child { text-align: right; }

        input { width: 96px; text-align: right; background: var(--input-bg); border: 1px solid transparent; outline: none; padding: 6px 10px; border-radius: 8px; transition: all 0.2s ease; font-weight: 500; color: var(--text-primary); }
        input:hover { background: var(--input-hover); }
        input:focus { background: var(--bg-card); border-color: #007aff; box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1); }
        
        .goal { color: #059669; font-weight: 600; }
        .asset { color: #2563eb; font-weight: 600; }
        .income { color: #059669; font-weight: 600; }
        .expense { color: #dc2626; }
        .calculated { color: #7c3aed; font-weight: 600; }
        .one-time { color: #f59e0b; font-weight: 600; }
        
        .chart-section { border-top: 1px solid var(--border-color); background: var(--bg-secondary); padding: 24px; }
        .chart-container { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color); padding: 24px; margin-bottom: 16px; position: relative; overflow: hidden; }
        .chart { width: 100%; height: 320px; max-width: 100%; contain: layout style; }
        .chart .main-line { animation: drawLine 1.5s ease-out forwards; stroke-dasharray: 2400; stroke-dashoffset: 2400; }
        @keyframes drawLine { to { stroke-dashoffset: 0; } }

        /* Performance optimizations */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; }
        }
        .tooltip { position: absolute; background: var(--bg-card); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-color); border-radius: 8px; padding: 8px 12px; box-shadow: var(--shadow-md); z-index: 20; display: none; font-size: 12px; color: var(--text-primary); pointer-events: none; transition: all 0.15s ease; }

        .stocks-section { border-top: 1px solid var(--border-color); background: var(--bg-secondary); padding: 24px; }
        .stock-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .stock-row { background: var(--bg-card); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); border-radius: 10px; padding: 14px 18px; display: flex; justify-content: space-between; align-items: center; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); will-change: transform, box-shadow; contain: layout style paint; }
        .stock-row:hover { box-shadow: var(--shadow-md); transform: translateY(-1px) translateZ(0); }
        .stock-row:active { transform: scale(0.98) translateZ(0); }
        .stock-row a { text-decoration: none; color: inherit; display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .stock-left { display: flex; align-items: center; gap: 12px; }
        .stock-symbol { font-weight: 600; color: var(--text-primary); font-size: 14px; min-width: 60px; }
        .stock-prices { font-size: 13px; color: var(--text-secondary); }
        .stock-gain { font-size: 14px; font-weight: 600; color: #30d158; min-width: 80px; text-align: right; }

        /* Mobile responsive breakpoints */
        @media (max-width: 768px) {
            .container { padding: 16px; }
            .header { padding: 12px 16px; }
            .chart-section { padding: 16px; }
            .chart-container { padding: 16px 8px; overflow-x: auto; }
            .chart { min-width: 700px; height: 280px; }
            .stocks-section { padding: 16px; }
            th, td { padding: 12px 16px; font-size: 15px; }
            th { font-size: 11px; }
            input { width: 100px; font-size: 15px; }
            .header h1 { font-size: 18px; }
            .summary-grid { grid-template-columns: 1fr; gap: 12px; }
            .collapse-header { padding: 14px 16px; }
            .back-button { width: 32px; height: 32px; font-size: 16px; }
        }

        @media (max-width: 480px) {
            body { width: 100vw; }
            .container { padding: 8px; width: 100%; max-width: 100vw; }
            .header { padding: 12px; gap: 8px; }
            .chart-section { display: none; }
            .stocks-section { padding: 12px; }
            .table-wrapper { -webkit-overflow-scrolling: touch; width: 100%; }
            table { min-width: 100%; width: 100%; }
            th, td { padding: 10px 8px; font-size: 14px; }
            th { font-size: 11px; padding: 8px; }
            input { width: 80px; font-size: 14px; padding: 4px 6px; }
            .header h1 { font-size: 16px; }
            .summary-section { padding: 12px; }
            .collapse-header { padding: 12px; font-size: 14px; }
            .summary-grid { grid-template-columns: 1fr; gap: 8px; }
            .card { margin-bottom: 12px; }
            .card:first-child { display: none; }
            .stock-row { padding: 10px 12px; }
            .stock-symbol { font-size: 13px; min-width: 50px; }
            .stock-prices { font-size: 12px; }
            .stock-gain { font-size: 13px; min-width: 60px; }
            .back-button { width: 30px; height: 30px; font-size: 16px; padding: 4px 8px; }
            .dark-mode-toggle { width: 32px; height: 32px; }
        }
        
        .summary-section { border-top: 1px solid var(--border-color); padding: 24px; }
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .summary-card { text-align: center; padding: 16px; border-radius: 12px; box-shadow: var(--shadow-sm); transition: all 0.2s ease; border: 1px solid var(--border-color); }
        .summary-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .green-bg { background: linear-gradient(135deg, rgba(236, 253, 245, 0.5) 0%, rgba(209, 250, 229, 0.5) 100%); }
        .blue-bg { background: linear-gradient(135deg, rgba(239, 246, 255, 0.5) 0%, rgba(219, 234, 254, 0.5) 100%); }
        .purple-bg { background: linear-gradient(135deg, rgba(250, 245, 255, 0.5) 0%, rgba(243, 232, 255, 0.5) 100%); }
        .summary-value { font-size: 20px; font-weight: 600; letter-spacing: -0.5px; }
        .green-text { color: #059669; }
        .blue-text { color: #007aff; }
        .purple-text { color: #7c3aed; }
        .summary-label { font-size: 11px; margin-top: 6px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.7; color: var(--text-secondary); }

        .back-button { background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 6px 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; width: 36px; height: 36px; text-decoration: none; color: var(--text-primary); font-size: 18px; font-weight: 600; will-change: transform; }
        .back-button:hover { background: var(--input-hover); transform: translateX(-2px) translateZ(0); }
        .back-button:active { transform: scale(0.95) translateX(-2px) translateZ(0); }

        .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #666; }
        .footer .heart { animation: heartbeat 2s ease-in-out infinite; display: inline-block; vertical-align: middle; }
        @keyframes heartbeat { 0% { transform: scale(1); } 10% { transform: scale(1.2); } 20% { transform: scale(1); } 30% { transform: scale(1.15); } 40% { transform: scale(1); } 100% { transform: scale(1); } }

        .collapse-header { cursor: pointer; padding: 16px 24px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; user-select: none; transition: all 0.2s ease; }
        .collapse-header:hover { opacity: 0.8; }
        .collapse-header:active { opacity: 0.6; }
        .collapse-arrow { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); font-size: 12px; color: var(--text-secondary); font-weight: 600; }
        .collapse-arrow.open { transform: rotate(180deg); }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .collapsible-content.open { max-height: 2000px; }

        .toggle-container { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 16px; padding: 14px; background: linear-gradient(135deg, rgba(239, 246, 255, 0.6) 0%, rgba(219, 234, 254, 0.6) 100%); border-radius: 12px; box-shadow: var(--shadow-sm); transition: all 0.2s ease; border: 1px solid rgba(147, 197, 253, 0.3); }
        .toggle-container:hover { box-shadow: var(--shadow-md); }
        body.dark-mode .toggle-container { background: linear-gradient(135deg, rgba(30, 58, 138, 0.3) 0%, rgba(29, 78, 216, 0.2) 100%); border: 1px solid rgba(96, 165, 250, 0.2); }
        .toggle-label { font-size: 14px; font-weight: 500; color: var(--text-primary); }
        .toggle-switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--input-bg); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 31px; }
        .toggle-slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: var(--bg-card); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .toggle-slider { background-color: #34c759; }
        input:checked + .toggle-slider:before { transform: translateX(20px); }

        select { padding: 8px 32px 8px 12px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 13px; background: var(--bg-card); font-weight: 500; cursor: pointer; transition: all 0.2s ease; appearance: none; background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%2386868b' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; color: var(--text-primary); }
        select:hover { background-color: var(--input-hover); }
        select:focus { outline: none; border-color: #007aff; box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1); }

        .dark-mode-toggle { background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; width: 36px; height: 36px; will-change: transform; }
        .dark-mode-toggle:hover { background: var(--input-hover); }
        .dark-mode-toggle:active { transform: scale(0.95) translateZ(0); }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; align-items: center; gap: 12px;">
            <a href="https://fuckingjoshua.com" class="back-button" aria-label="Back to home">‹</a>
            <div>
                <h1 style="display: flex; align-items: center; gap: 8px;">
                    Marlin
                    <span style="font-size: 11px; font-weight: 500; background: rgba(0, 122, 255, 0.1); color: #007aff; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px;">USD</span>
                </h1>
                <div style="display: flex; gap: 12px; margin-top: 2px;">
                    <div id="lastUpdated" style="font-size: 11px; color: var(--text-secondary);">Loading...</div>
                    <div style="font-size: 11px; color: var(--text-secondary);">•</div>
                    <div id="nextPayday" style="font-size: 11px; color: var(--text-secondary);">Next pay: 10/22, 11/19, 12/17</div>
                </div>
            </div>
        </div>
        <button class="dark-mode-toggle" onclick="toggleDarkMode()" aria-label="Toggle dark mode">
            <svg id="darkModeIcon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--text-primary);">
                <path d="M10 3V1M10 19V17M17 10H19M1 10H3M15.66 15.66L17.07 17.07M2.93 2.93L4.34 4.34M15.66 4.34L17.07 2.93M2.93 17.07L4.34 15.66" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <circle cx="10" cy="10" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
            </svg>
        </button>
    </div>

    <div class="container">
        <div class="card" style="margin-bottom: 24px;">
            <div class="chart-section" style="border-top: none; padding-top: 24px;">
                <h3 style="font-weight: 600; margin-bottom: 16px; color: var(--text-primary); letter-spacing: -0.3px;">Portfolio Growth</h3>
                <div class="chart-container">
                    <svg id="chart" viewBox="0 0 1000 300" class="chart" preserveAspectRatio="xMidYMid meet">
                        <!-- Dynamic chart content -->
                    </svg>
                    <div id="tooltip" class="tooltip"></div>
                </div>

                <div class="toggle-container">
                    <span class="toggle-label">Use Extra Income</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="potentialIncomeToggle" onchange="togglePotentialIncome()">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="toggle-label" id="currentIncomeLabel">($774)</span>
                </div>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 20px;">
                    <div style="text-align: center; padding: 12px; border-radius: 6px; background: var(--bg-card); box-shadow: var(--shadow-sm); border: 1px solid rgba(110, 231, 183, 0.3);">
                        <div id="progressValue" style="font-size: 18px; font-weight: 600; color: #6ee7b7;">12.7%</div>
                        <div style="font-size: 12px; margin-top: 4px; color: var(--text-secondary);">Progress</div>
                    </div>
                    <div style="text-align: center; padding: 12px; border-radius: 6px; background: var(--bg-card); box-shadow: var(--shadow-sm); border: 1px solid rgba(147, 197, 253, 0.3);">
                        <div id="monthlyTarget" style="font-size: 18px; font-weight: 600; color: #93c5fd;">$417</div>
                        <div style="font-size: 12px; margin-top: 4px; color: var(--text-secondary);">Monthly Target</div>
                    </div>
                    <div style="text-align: center; padding: 12px; border-radius: 6px; background: var(--bg-card); box-shadow: var(--shadow-sm); border: 1px solid rgba(196, 181, 253, 0.3);">
                        <div id="monthlySurplus" style="font-size: 18px; font-weight: 600; color: #c4b5fd;">-$69</div>
                        <div style="font-size: 12px; margin-top: 4px; color: var(--text-secondary);">Monthly Surplus</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="collapse-header" onclick="toggleBudget()">
                <h3 style="font-weight: 600; margin: 0; color: var(--text-primary); font-size: 16px; letter-spacing: -0.3px;">Budget Details</h3>
                <span class="collapse-arrow" id="budgetArrow">▼</span>
            </div>
            <div class="collapsible-content" id="budgetContent">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="collapse-header" onclick="togglePortfolio()">
                <h3 style="font-weight: 600; margin: 0; color: var(--text-primary); font-size: 16px; letter-spacing: -0.3px;">Portfolio Targets</h3>
                <span class="collapse-arrow" id="portfolioArrow">▼</span>
            </div>
            <div class="collapsible-content" id="portfolioContent">
                <div class="stocks-section" style="border-top: none; padding-top: 0;">
                    <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-radius: 12px; padding: 16px; margin-bottom: 20px; margin-top: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.04);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-weight: 600; color: #059669; font-size: 14px;">Moderately bullish 2030 targets</div>
                            <select id="sortBy">
                                <option value="gain">By Potential %</option>
                                <option value="holdings">By Holdings (Amount)</option>
                                <option value="price">By Price</option>
                                <option value="alpha">By Ticker</option>
                            </select>
                        </div>
                    </div>

                    <div id="portfolioValueCard" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 16px; border-radius: 12px; background: var(--bg-card); box-shadow: var(--shadow-sm); border: 1px solid rgba(147, 197, 253, 0.3);">
                            <div id="currentPortfolioValue" style="font-size: 20px; font-weight: 600; color: #93c5fd; letter-spacing: -0.5px;">$0</div>
                            <div style="font-size: 11px; margin-top: 6px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary);">Current Value</div>
                        </div>
                        <div style="text-align: center; padding: 16px; border-radius: 12px; background: var(--bg-card); box-shadow: var(--shadow-sm); border: 1px solid rgba(110, 231, 183, 0.3);">
                            <div id="targetPortfolioValue" style="font-size: 20px; font-weight: 600; color: #6ee7b7; letter-spacing: -0.5px;">$0</div>
                            <div style="font-size: 11px; margin-top: 6px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary);">Target Value</div>
                        </div>
                    </div>

                    <div class="stock-list">
                        <!-- Stock rows will be dynamically rendered here -->
                    </div>
                </div>
            </div>

            <div class="collapse-header" onclick="toggleCrypto()">
                <h3 style="font-weight: 600; margin: 0; color: var(--text-primary); font-size: 16px; letter-spacing: -0.3px;">Crypto Watchlist</h3>
                <span class="collapse-arrow" id="cryptoArrow">▼</span>
            </div>
            <div class="collapsible-content" id="cryptoContent">
                <div class="stocks-section" style="border-top: none; padding-top: 0;">
                    <div style="background: linear-gradient(135deg, #f0e7ff 0%, #e0d7ff 100%); border-radius: 12px; padding: 16px; margin: 16px 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.04);">
                        <div style="font-weight: 600; color: #7c3aed; font-size: 14px;">Moderately bullish 2030 targets (not holdings)</div>
                    </div>
                    <div class="crypto-list" style="margin: 0 20px 20px 20px;">
                        <!-- Crypto cards will be dynamically rendered here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Portfolio Insights -->
        <div class="card" style="margin-top: 24px;">
            <div style="padding: 24px; border-bottom: 1px solid var(--border-color);">
                <h3 style="font-weight: 600; margin: 0; color: var(--text-primary); font-size: 16px; letter-spacing: -0.3px; display: flex; align-items: center; gap: 8px;">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: #7c3aed;">
                        <path d="M10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2Z" stroke="currentColor" stroke-width="2"/>
                        <path d="M10 6V10L13 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    Market Insights
                </h3>
            </div>
            <div style="padding: 24px; background: var(--bg-secondary);">
                <div id="aiInsights" style="font-size: 14px; line-height: 1.6; color: var(--text-primary);">
                    <!-- Insights will be dynamically generated -->
                </div>
            </div>
        </div>
    </div>

    <div class="footer" style="padding-bottom: 40px;">Made with <svg class="heart" width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.0 0 0 0 0-7.78z" fill="#FF4136"/></svg> in Vancouver, BC</div>

    <script>
        // Dark mode handling
        function initDarkMode() {
            const saved = localStorage.getItem('darkMode');
            if (saved === 'dark' || (saved === null && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.add('light-mode');
            }
        }

        function toggleDarkMode() {
            if (document.body.classList.contains('dark-mode')) {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                localStorage.setItem('darkMode', 'light');
            } else {
                document.body.classList.remove('light-mode');
                document.body.classList.add('dark-mode');
                localStorage.setItem('darkMode', 'dark');
            }
            updateChart(); // Redraw chart with new colors
        }

        initDarkMode();

        // All amounts in USD (converted from CAD at 1 CAD = 0.73 USD)
        let data = [
            { category: 'Goal', amount: 2190, type: 'goal' },
            { category: 'Wallet / Savings', amount: 884, type: 'asset' },
            { category: 'iPhone Sale (One-time)', amount: 584, type: 'one-time' },
            { category: 'Potential Income', amount: 1267, type: 'asset' },
            { category: 'Income', amount: 774, type: 'income' },
            { category: 'Food', amount: 290, type: 'expense' },
            { category: 'iPhone (Monthly)', amount: 77, type: 'expense' },
            { category: 'Apple Watch Ultra 3 (Monthly)', amount: 33, type: 'expense' },
            { category: 'Claude', amount: 20, type: 'expense' }
        ];

        let usePotentialIncome = false;

        function get(category) {
            const item = data.find(item => item.category === category);
            return item ? item.amount : 0;
        }

        function calculateSurplus() {
            const income = usePotentialIncome ? get('Potential Income') : get('Income');
            const totalExpenses = get('Food') + get('iPhone (Monthly)') + get('Apple Watch Ultra 3 (Monthly)') + get('Claude');
            return income - totalExpenses;
        }

        function togglePotentialIncome() {
            usePotentialIncome = document.getElementById('potentialIncomeToggle').checked;
            const income = usePotentialIncome ? get('Potential Income') : get('Income');
            document.getElementById('currentIncomeLabel').textContent = `($${income.toLocaleString()})`;
            updateAll();
        }

        function calculateNeeded() {
            return get('Goal') - get('Wallet / Savings');
        }

        function projectValue(months) {
            const r = 0.01; // Individual stocks: 1.0% monthly (12.7% annual)
            const surplus = calculateSurplus();

            const fv = get('Wallet / Savings') * Math.pow(1 + r, months);
            const annuity = surplus * ((Math.pow(1 + r, months) - 1) / r);

            // Ensure the line never goes down - minimum is compound growth on existing balance
            return Math.max(fv, fv + annuity);
        }

        function generateChartData() {
            const chartData = [];
            const r = 0.01; // 1.0% monthly growth rate (12.7% annual)
            const currentValue = get('Wallet / Savings');
            const surplus = calculateSurplus();
            const monthsAgo = 24; // Start from 24 months ago for better centering

            // Generate past data (from -24 to 0) - started from $0 in Oct 2024
            for (let i = -monthsAgo; i <= 0; i++) {
                const date = new Date(Date.now() + i * 30 * 24 * 60 * 60 * 1000);
                const monthYear = date.toLocaleDateString('en', { month: 'short', year: '2-digit' });

                let val;
                if (i === 0) {
                    // At NOW, show the actual current wallet balance
                    val = currentValue;
                } else if (i >= -12) {
                    // Linear growth from $0 (Oct 2024) to current value (now)
                    // Only show growth for the last 12 months
                    const monthsElapsed = 12 + (i + 12);
                    val = (currentValue / 12) * monthsElapsed;
                } else {
                    // Before Oct 2024, show $0
                    val = 0;
                }

                chartData.push({
                    month: monthYear.replace(/(\d{2})$/, "'$1"),
                    val: val,
                    monthIndex: i
                });
            }

            // Generate future data (from 1 to 48 months to balance the view)
            for (let i = 1; i <= 48; i++) {
                const date = new Date(Date.now() + i * 30 * 24 * 60 * 60 * 1000);
                const monthYear = date.toLocaleDateString('en', { month: 'short', year: '2-digit' });
                chartData.push({
                    month: monthYear.replace(/(\d{2})$/, "'$1"),
                    val: projectValue(i),
                    monthIndex: i
                });
            }

            return chartData;
        }

        function updateTable() {
            const tbody = document.getElementById('dataTable');
            const surplus = calculateSurplus();
            const needed = calculateNeeded();
            
            tbody.innerHTML = '';
            
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 500;">${item.category}</td>
                    <td>
                        <input type="text" value="${item.amount.toLocaleString()}" 
                               class="${item.type}" data-index="${index}"
                               onchange="updateValue(${index}, this.value)">
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Add calculated rows
            const incomeDiff = get('Potential Income') - get('Income');
            const incomeDiffRow = document.createElement('tr');
            incomeDiffRow.innerHTML = `
                <td style="font-weight: 500;">Income Difference</td>
                <td class="calculated">$${incomeDiff.toLocaleString()}</td>
            `;
            tbody.appendChild(incomeDiffRow);

            const surplusRow = document.createElement('tr');
            surplusRow.innerHTML = `
                <td style="font-weight: 500;">Monthly Surplus</td>
                <td class="calculated">$${surplus.toLocaleString()}</td>
            `;
            tbody.appendChild(surplusRow);

            const neededRow = document.createElement('tr');
            neededRow.innerHTML = `
                <td style="font-weight: 500;">Amount Needed</td>
                <td class="calculated">$${needed.toLocaleString()}</td>
            `;
            tbody.appendChild(neededRow);
        }

        function updateChart() {
            requestAnimationFrame(() => {
                const chartData = generateChartData();
                const maxVal = Math.max(...chartData.map(d => d.val));
                const minVal = Math.min(...chartData.map(d => d.val));
                const svg = document.getElementById('chart');

            // Fixed dimensions
            const marginTop = 20;
            const marginBottom = 35;
            const chartHeight = 245;
            const labelY = 285;
            const hoverHeight = 245;

            // Dark mode aware colors
            const isDark = document.body.classList.contains('dark-mode');
            const gridColor = isDark ? 'rgba(255,255,255,0.1)' : '#e5e7eb';
            const textColor = isDark ? '#98989d' : '#6b7280';

            svg.innerHTML = '';

            // Add grid lines and Y-axis labels (both sides)
            for (let i = 0; i <= 4; i++) {
                const y = marginTop + (i * chartHeight / 4);
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', '60');
                line.setAttribute('y1', y);
                line.setAttribute('x2', '960');
                line.setAttribute('y2', y);
                line.setAttribute('stroke', gridColor);
                line.setAttribute('stroke-width', '1');
                svg.appendChild(line);

                const val = maxVal - (i * (maxVal - minVal) / 4);

                // Left Y-axis label
                const labelLeft = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                labelLeft.setAttribute('x', '50');
                labelLeft.setAttribute('y', y + 4);
                labelLeft.setAttribute('text-anchor', 'end');
                labelLeft.setAttribute('font-size', '11');
                labelLeft.setAttribute('fill', textColor);
                labelLeft.textContent = '$' + Math.round(val).toLocaleString();
                svg.appendChild(labelLeft);

                // Right Y-axis label
                const labelRight = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                labelRight.setAttribute('x', '970');
                labelRight.setAttribute('y', y + 4);
                labelRight.setAttribute('text-anchor', 'start');
                labelRight.setAttribute('font-size', '11');
                labelRight.setAttribute('fill', textColor);
                labelRight.textContent = '$' + Math.round(val).toLocaleString();
                svg.appendChild(labelRight);
            }

            const bottomY = marginTop + chartHeight;
            const goal = get('Goal');

            // Create polyline
            const points = chartData.map((d, i) => `${80 + (i * 860/(chartData.length-1))},${bottomY - ((d.val-minVal)/(maxVal-minVal)) * chartHeight}`).join(' ');
            const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
            polyline.setAttribute('points', points);
            polyline.setAttribute('fill', 'none');
            polyline.setAttribute('stroke', '#4ade80');
            polyline.setAttribute('stroke-width', '3');
            polyline.setAttribute('class', 'main-line');
            svg.appendChild(polyline);

            // Add hover highlight circle
            const hoverCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            hoverCircle.setAttribute('r', '6');
            hoverCircle.setAttribute('fill', '#4ade80');
            hoverCircle.setAttribute('stroke', 'white');
            hoverCircle.setAttribute('stroke-width', '2');
            hoverCircle.setAttribute('opacity', '0');
            hoverCircle.setAttribute('id', 'hoverCircle');
            svg.appendChild(hoverCircle);

            // Add milestone markers (25%, 50%, 75%, 100% of goal)
            [0.25, 0.5, 0.75, 1.0].forEach(pct => {
                const milestoneVal = goal * pct;
                if (milestoneVal >= minVal && milestoneVal <= maxVal) {
                    const milestoneY = bottomY - ((milestoneVal - minVal) / (maxVal - minVal)) * chartHeight;

                    // Subtle dashed line
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', '60');
                    line.setAttribute('y1', milestoneY);
                    line.setAttribute('x2', '960');
                    line.setAttribute('y2', milestoneY);
                    line.setAttribute('stroke', pct === 1.0 ? '#059669' : '#86868b');
                    line.setAttribute('stroke-width', '1');
                    line.setAttribute('stroke-dasharray', '4,4');
                    line.setAttribute('opacity', pct === 1.0 ? '0.4' : '0.2');
                    svg.appendChild(line);

                    // Small label
                    const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    label.setAttribute('x', pct === 1.0 ? '965' : '65');
                    label.setAttribute('y', milestoneY - 4);
                    label.setAttribute('text-anchor', pct === 1.0 ? 'end' : 'start');
                    label.setAttribute('font-size', '10');
                    label.setAttribute('font-weight', '600');
                    label.setAttribute('fill', pct === 1.0 ? '#059669' : textColor);
                    label.setAttribute('opacity', '0.6');
                    label.textContent = pct === 1.0 ? 'GOAL' : `${pct * 100}%`;
                    svg.appendChild(label);
                }
            });

            // Add circles and hover areas for all months
            chartData.forEach((d, i) => {
                const x = 80 + (i * 860/(chartData.length-1));
                const y = bottomY - ((d.val-minVal)/(maxVal-minVal)) * chartHeight;

                // Show circles only at yearly intervals and endpoints
                const showDot = (i % 12 === 0 && i !== 12) || i === 0 || i === chartData.length - 1;
                if (showDot && d.monthIndex !== 0) {
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', x);
                    circle.setAttribute('cy', y);
                    circle.setAttribute('r', '4');
                    circle.setAttribute('fill', '#4ade80');
                    svg.appendChild(circle);
                }

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', x - 20);
                rect.setAttribute('y', marginTop);
                rect.setAttribute('width', '40');
                rect.setAttribute('height', hoverHeight);
                rect.setAttribute('fill', 'transparent');
                rect.style.cursor = 'pointer';
                rect.addEventListener('mouseenter', () => {
                    showTooltip(i, d);
                    const hoverCircle = document.getElementById('hoverCircle');
                    if (hoverCircle) {
                        hoverCircle.setAttribute('cx', x);
                        hoverCircle.setAttribute('cy', y);
                        hoverCircle.setAttribute('opacity', '1');
                    }
                });
                rect.addEventListener('mouseleave', () => {
                    hideTooltip();
                    const hoverCircle = document.getElementById('hoverCircle');
                    if (hoverCircle) hoverCircle.setAttribute('opacity', '0');
                });
                svg.appendChild(rect);
            });

            // Add "NOW" marker at month 0 (which is at index 24 in the array)
            const nowIndex = chartData.findIndex(d => d.monthIndex === 0);
            if (nowIndex >= 0) {
                const currentX = 80 + (nowIndex * 860/(chartData.length-1));
                const currentY = bottomY - ((chartData[nowIndex].val-minVal)/(maxVal-minVal)) * chartHeight;
                const marker = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                marker.setAttribute('cx', currentX);
                marker.setAttribute('cy', currentY);
                marker.setAttribute('r', '7');
                marker.setAttribute('fill', '#2563eb');
                marker.setAttribute('stroke', 'white');
                marker.setAttribute('stroke-width', '2');
                svg.appendChild(marker);

                const currentLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                currentLabel.setAttribute('x', currentX);
                currentLabel.setAttribute('y', currentY - 14);
                currentLabel.setAttribute('text-anchor', 'middle');
                currentLabel.setAttribute('font-size', '12');
                currentLabel.setAttribute('font-weight', '600');
                currentLabel.setAttribute('fill', '#2563eb');
                currentLabel.textContent = 'NOW';
                svg.appendChild(currentLabel);
            }

            // Add month labels (every 12 months for better spacing with longer timeline)
            chartData.forEach((d, i) => {
                if (i % 12 === 0 || d.monthIndex === 0) {
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', 80 + (i * 860/(chartData.length-1)));
                    text.setAttribute('y', labelY);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('font-size', '12');
                    text.setAttribute('fill', textColor);
                    text.textContent = d.month;
                    svg.appendChild(text);
                }
            });
            });
        }

        function showTooltip(index, data, event) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <div style="font-weight: 600; font-size: 11px; opacity: 0.7;">${data.month}</div>
                <div style="color: #059669; font-weight: 600; font-size: 14px;">$${Math.round(data.val).toLocaleString()}</div>
            `;
            tooltip.style.display = 'block';
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        function updateValue(index, value) {
            const cleanValue = parseFloat(value.replace(/,/g, '')) || 0;
            data[index].amount = cleanValue;
            updateAll();
        }

        function updateSummary() {
            const progress = (get('Wallet / Savings') / get('Goal') * 100).toFixed(1);
            const surplus = calculateSurplus();
            const needed = calculateNeeded();
            const monthlyTarget = Math.round(needed / 21);
            
            document.getElementById('progressValue').textContent = `${progress}%`;
            document.getElementById('monthlyTarget').textContent = `$${monthlyTarget.toLocaleString()}`;
            document.getElementById('monthlySurplus').textContent = `$${surplus.toLocaleString()}`;
        }

        function updateAll() {
            updateTable();
            updateChart();
            updateSummary();
        }

        // Stock data (your actual portfolio)
        const stocks = {
            'PLTR': { current: 179.27, target: 550, year: 2030, shares: 0.5264 },
            'HOOD': { current: 133.40, target: 250, year: 2030, shares: 0.5409 },
            'GOOGL': { current: 252.91, target: 450, year: 2030, shares: 0.326 },
            'APP': { current: 603.95, target: 1200, year: 2030, shares: 0.1217 },
            'AAPL': { current: 247.38, target: 450, year: 2030, shares: 0.3042 },
            'IAU': { current: 80.70, target: 180, year: 2030, shares: 0.0372 },
            'SLV': { current: 49.15, target: 150, year: 2030, shares: 0.5251 }
        };

        // Crypto watchlist (not holdings, just tracking)
        const cryptos = {
            'bitcoin': { symbol: 'BTC', current: 108564, change24h: 0, target: 500000, year: '2030' },
            'ethereum': { symbol: 'ETH', current: 3893.65, change24h: 0, target: 15000, year: '2030' },
            'solana': { symbol: 'SOL', current: 187.75, change24h: 0, target: 800, year: '2030' }
        };

        // Calculate portfolio values
        function calculatePortfolioValue() {
            let currentValue = 0;
            let targetValue = 0;

            for (const sym in stocks) {
                const stock = stocks[sym];
                currentValue += stock.current * stock.shares;
                targetValue += stock.target * stock.shares;
            }

            return { currentValue, targetValue };
        }

        // Price cache to avoid API rate limits
        const priceCache = { stocks: {}, cryptos: {}, lastUpdate: 0 };
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

        // Fetch stock price with better error handling
        async function fetchStockPrice(symbol) {
            try {
                const res = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`, {
                    headers: { 'User-Agent': 'Mozilla/5.0' }
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                return parseFloat(data.chart.result[0].meta.regularMarketPrice.toFixed(2));
            } catch (e) {
                console.warn(`Yahoo Finance failed for ${symbol}, using cached price`);
                return null;
            }
        }

        // Fetch crypto prices from CoinGecko (no API key needed, no rate limits)
        async function fetchCryptoPrices() {
            try {
                const ids = Object.keys(cryptos).join(',');
                const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd&include_24hr_change=true`);
                const data = await res.json();

                for (const [id, crypto] of Object.entries(cryptos)) {
                    if (data[id]) {
                        crypto.current = data[id].usd;
                        crypto.change24h = data[id].usd_24h_change || 0;
                    }
                }
                return true;
            } catch (e) {
                console.error('Error fetching crypto prices:', e);
                return false;
            }
        }

        // Update all prices with caching
        async function updatePrices() {
            const now = Date.now();
            if (now - priceCache.lastUpdate < CACHE_DURATION) {
                console.log('Using cached prices');
                return;
            }

            // Update crypto prices (always works, no rate limits)
            await fetchCryptoPrices();
            renderCryptoCards();

            // Try to update stock prices (may fail due to rate limits)
            let successCount = 0;
            for (const sym in stocks) {
                const price = await fetchStockPrice(sym);
                if (price) {
                    stocks[sym].current = price;
                    successCount++;
                }
                await new Promise(r => setTimeout(r, 300)); // Slower to avoid rate limits
            }

            priceCache.lastUpdate = now;
            const time = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            const status = successCount > 0 ? `Updated ${successCount}/${Object.keys(stocks).length} stocks` : 'Using cached prices';
            document.getElementById('lastUpdated').textContent = `${time} • ${status}`;

            renderCards();
            generateAIInsights(); // Regenerate insights with new prices
        }

        // Update portfolio value display
        function updatePortfolioDisplay() {
            const { currentValue, targetValue } = calculatePortfolioValue();
            document.getElementById('currentPortfolioValue').textContent = `$${Math.round(currentValue).toLocaleString()}`;
            document.getElementById('targetPortfolioValue').textContent = `$${Math.round(targetValue).toLocaleString()}`;
        }

        // Sort and render stock rows
        function renderCards() {
            const sortBy = document.getElementById('sortBy').value;
            const sorted = Object.entries(stocks).sort((a, b) => {
                if (sortBy === 'gain') {
                    const gA = ((a[1].target - a[1].current) / a[1].current) * 100;
                    const gB = ((b[1].target - b[1].current) / b[1].current) * 100;
                    return gB - gA;
                }
                if (sortBy === 'holdings') {
                    const holdingA = a[1].current * a[1].shares;
                    const holdingB = b[1].current * b[1].shares;
                    return holdingB - holdingA;
                }
                if (sortBy === 'price') return b[1].current - a[1].current;
                if (sortBy === 'alpha') return a[0].localeCompare(b[0]);
            });

            const list = document.querySelector('.stock-list');
            list.innerHTML = sorted.map(([sym, s]) => {
                const gain = Math.round(((s.target - s.current) / s.current) * 100);
                const currentValue = (s.current * s.shares).toFixed(2);
                return `<div class="stock-row">
                    <a href="https://finance.yahoo.com/quote/${sym}" target="_blank">
                        <div class="stock-left">
                            <div class="stock-symbol">${sym}</div>
                            <div class="stock-prices">${s.shares} shares • $${s.current.toLocaleString()} → $${s.target.toLocaleString()} (${s.year})</div>
                        </div>
                        <div class="stock-gain">+${gain}%</div>
                    </a>
                </div>`;
            }).join('');

            // Update portfolio values after rendering
            updatePortfolioDisplay();
        }

        // Render crypto cards
        function renderCryptoCards() {
            const list = document.querySelector('.crypto-list');
            if (!list) return;

            const sorted = Object.entries(cryptos).sort((a, b) => b[1].current - a[1].current);

            list.innerHTML = sorted.map(([id, crypto]) => {
                const gain = Math.round(((crypto.target - crypto.current) / crypto.current) * 100);
                const price = crypto.current > 0 ? `$${crypto.current.toLocaleString(undefined, { maximumFractionDigits: 0 })}` : 'Loading...';
                const target = `$${crypto.target.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;

                return `<div class="stock-row" style="margin-bottom: 8px;">
                    <a href="https://www.coingecko.com/en/coins/${id}" target="_blank">
                        <div class="stock-left">
                            <div class="stock-symbol">${crypto.symbol}</div>
                            <div class="stock-prices">${price} → ${target} (${crypto.year})</div>
                        </div>
                        <div class="stock-gain">+${gain}%</div>
                    </a>
                </div>`;
            }).join('');
        }

        // Toggle sections
        function toggleBudget() {
            const content = document.getElementById('budgetContent');
            const arrow = document.getElementById('budgetArrow');
            content.classList.toggle('open');
            arrow.classList.toggle('open');
        }

        function togglePortfolio() {
            const content = document.getElementById('portfolioContent');
            const arrow = document.getElementById('portfolioArrow');
            content.classList.toggle('open');
            arrow.classList.toggle('open');
        }

        function toggleCrypto() {
            const content = document.getElementById('cryptoContent');
            const arrow = document.getElementById('cryptoArrow');
            content.classList.toggle('open');
            arrow.classList.toggle('open');
        }

        // Generate AI portfolio insights (automated based on live data)
        function generateAIInsights() {
            const { currentValue, targetValue } = calculatePortfolioValue();
            const potentialGain = ((targetValue - currentValue) / currentValue * 100).toFixed(1);

            // Analyze portfolio composition
            const techStocks = ['PLTR', 'GOOGL', 'AAPL', 'APP', 'HOOD'];
            const techExposure = Object.entries(stocks)
                .filter(([sym]) => techStocks.includes(sym))
                .reduce((sum, [_, stock]) => sum + (stock.current * stock.shares), 0);
            const techPercent = (techExposure / currentValue * 100).toFixed(0);

            const safeHavenStocks = ['IAU', 'SLV'];
            const safeHavenExposure = Object.entries(stocks)
                .filter(([sym]) => safeHavenStocks.includes(sym))
                .reduce((sum, [_, stock]) => sum + (stock.current * stock.shares), 0);
            const safeHavenPercent = (safeHavenExposure / currentValue * 100).toFixed(0);

            // Top holdings by value
            const topHoldings = Object.entries(stocks)
                .map(([sym, stock]) => ({ sym, value: stock.current * stock.shares }))
                .sort((a, b) => b.value - a.value)
                .slice(0, 3);

            // Find stocks with highest upside
            const topOpportunities = Object.entries(stocks)
                .map(([sym, stock]) => ({
                    sym,
                    upside: ((stock.target - stock.current) / stock.current * 100).toFixed(0),
                    year: stock.year,
                    current: stock.current
                }))
                .sort((a, b) => parseFloat(b.upside) - parseFloat(a.upside))
                .slice(0, 3);

            const insights = `
                <div style="margin-bottom: 16px;">
                    <p style="margin: 0; color: var(--text-secondary); font-size: 15px; line-height: 1.7;">
                        Portfolio at <strong>$${Math.round(currentValue)}</strong> with <strong>+${potentialGain}%</strong> upside to targets (${techPercent}% tech, ${safeHavenPercent}% metals).
                        Top positions: ${topHoldings.map(h => `${h.sym} ($${Math.round(h.value)})`).join(', ')}.
                    </p>
                </div>

                <div style="margin-bottom: 16px;">
                    <strong style="color: #7c3aed; font-size: 14px;">Best Opportunities</strong>
                    <p style="margin: 8px 0 0 0; color: var(--text-secondary);">
                        ${topOpportunities.slice(0, 3).map(s => `<strong>${s.sym}</strong> +${s.upside}%`).join(' • ')}
                    </p>
                </div>

                <div>
                    <p style="margin: 0; color: var(--text-secondary); font-size: 13px; font-style: italic;">
                        Market volatility ahead due to Q4 earnings season and macro uncertainty. Focus DCA on highest-conviction tech positions (PLTR, APP, AAPL). Silver (SLV) provides downside hedge with potential 2030 upside. Consider rebalancing into underweight positions when opportunities arise. Watch for quality entry points in high-growth names.
                    </p>
                </div>
            `;

            document.getElementById('aiInsights').innerHTML = insights;
        }

        // Initialize
        updateAll();
        renderCards();
        renderCryptoCards();
        updatePrices();
        generateAIInsights();
        setInterval(updatePrices, 5 * 60 * 1000); // Update every 5 minutes (avoids rate limits)
        document.getElementById('sortBy').addEventListener('change', renderCards);

        // Auto-open portfolio on mobile
        if (window.innerWidth <= 480) {
            document.getElementById('portfolioContent').classList.add('open');
            document.getElementById('portfolioArrow').classList.add('open');
        }
    </script>
</body>
</html>